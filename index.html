<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-MG8CHP26VF"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
      gtag("config", "G-MG8CHP26VF");
    </script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Word of the Day</title>
    <!-- Open Graph Meta Tags for Share Preview -->
    <meta property="og:title" content="FlyTie - Phrase of the Day" />
    <meta property="og:description" content="Learn new professional phrases daily with FlyTie!" />
    <meta property="og:image" content="https://learntrend.github.io/images/logo.png" />
    <meta property="og:image:type" content="image/png" />
    <meta property="og:image:width" content="200" />
    <meta property="og:image:height" content="200" />
    <meta property="og:url" content="https://learntrend.github.io" />
    <meta property="og:type" content="website" />
    <!-- Favicon -->
    <link rel="icon" href="images/logo.png" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600&family=Open+Sans&display=swap" rel="stylesheet" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <style>
      body {
        margin: 0;
        font-family: "Open Sans", sans-serif;
        background-color: #f4f6fb;
        color: #222;
        display: flex;
        height: 100vh;
        flex-direction: column;
      }
      body.no-scroll {
        overflow: hidden;
      }
      /* Top Nav */
      .top-nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #2e8bc0;
        padding: 10px 20px;
        padding-left: 05px;
        color: #fff;
      }
      .top-nav .left {
        display: flex;
        gap: 05px;
        align-items: center;
        position: relative;
      }
      .app-logo {
        height: 25px;
        max-width: 180px;
        object-fit: contain;
      }
      .top-nav button {
        background: #fff;
        color: #2e8bc0;
        border: none;
        padding: 12px 15px;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        transition: 0.3s;
        font-size: 16px;
        line-height: 16px;
        display: flex;
        align-items: center;
        gap: 5px;
      }
      #logoBtn {
        padding: 7.5px 10px;
      }
      .top-nav button:disabled {
        background: #ccc;
        color: #666;
        cursor: not-allowed;
      }
      .top-nav button:hover:enabled {
        background: #145da0;
        color: #fff;
      }
      .top-nav button.active {
        background: #145da0;
        color: #fff;
      }
      .dropdown-menu {
        display: none;
        position: absolute;
        top: 100%;
        right: 0;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        min-width: 150px;
      }
      .dropdown-menu button {
        width: 100%;
        text-align: left;
        border-radius: 0;
        padding: 10px 15px;
        font-size: 14px;
        font-weight: normal;
      }
      .dropdown-menu button:hover {
        background: #145da0;
        color: #fff;
      }
      .main {
        flex: 1;
        padding: 20px;
        display: flex;
        flex-direction: column;
      }
      .card {
        background: #fff;
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        text-align: center;
        position: relative;
        min-height: 300px;
      }
      .card h2 {
        font-family: "Montserrat", sans-serif;
        margin-bottom: 15px;
        padding: 10px;
      }
      .card p {
        padding: 10px;
      }

      .action-buttons {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 20px;
        align-items: center;
      }
      .action-buttons button {
        background: #fff;
        color: #2e8bc0;
        border: none;
        padding: 8px;
        border-radius: 8px;
        cursor: pointer;
        transition: 0.3s;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .action-buttons button:hover:enabled:not(#shareBtn):not(#bookmarkBtn) {
        color: red;
      }
      .action-buttons #shareBtn:active,
      .action-buttons #shareBtn:focus {
        color: #2e8bc0;
        background: #fff;
      }
      .bookmark-btn {
        background: #fff;
        color: #2e8bc0;
        border: none;
        padding: 8px;
      }
      .bookmark-btn.bookmarked {
        background: #145da0;
        color: #fff;
      }
      .bookmark-btn:hover:enabled {
        background: #145da0;
        color: #fff;
      }
      .bookmark-btn.bookmarked i {
        color: #fff;
      }
      .action-buttons .bookmark-btn:not(.bookmarked) {
        background: #fff !important;
      }
      .bookmark-btn:not(.bookmarked) i {
        color: #2e8bc0;
      }
      .bookmark-btn:not(.bookmarked):active,
      .bookmark-btn:not(.bookmarked):focus {
        background: #fff;
        color: #2e8bc0;
      }
      .action-buttons button:disabled {
        background: #ccc;
        color: #666;
        cursor: not-allowed;
      }
      /* Navigation buttons */
      .nav-buttons {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 20px;
      }
      .nav-buttons button {
        background: #2e8bc0;
        border: none;
        padding: 15px 40px;
        border-radius: 10px;
        color: #fff;
        font-size: 16px;
        cursor: pointer;
        transition: 0.3s;
        width: 120px;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
      }
      .nav-buttons button:hover:enabled {
        background: #145da0;
      }
      .nav-buttons button:disabled {
        background: #ccc;
        color: #666;
        cursor: not-allowed;
      }
      /* Comments Section */
      .comments {
        flex: 1;
        background: #fff;
        border-radius: 12px;
        padding: 15px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
      }
      .comments-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }
      .stats {
        font-size: 14px;
        color: #555;
      }
      .stats i {
        color: #666;
      }
      .actions {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .actions button {
        background: #fff;
        color: #2e8bc0;
        border: none;
        padding: 8px 8px;
        border-radius: 8px;
        cursor: pointer;
        transition: 0.3s;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 5px;
      }
      .actions button:hover:enabled {
        background: #145da0;
        color: #fff;
      }
      .actions button:disabled {
        background: #ccc;
        color: #666;
        cursor: not-allowed;
      }
      .comment-list {
        max-height: 400px;
        overflow-y: auto;
        margin-bottom: 12px;
      }
      .comment {
        margin-bottom: 12px;
        padding: 10px;
        border-bottom: 1px solid #eee;
      }
      .comment strong {
        display: block;
        color: #145da0;
      }
      .comment-actions {
        display: flex;
        gap: 10px;
        margin-top: 5px;
      }
      .comment-actions button {
        background: #fff;
        color: #2e8bc0;
        border: none;
        padding: 5px 8px;
        border-radius: 8px;
        cursor: pointer;
        transition: 0.3s;
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 5px;
      }
      .comment-actions button:hover:enabled {
        background: #145da0;
        color: #fff;
      }
      .comment-actions button:disabled {
        background: #ccc;
        color: #666;
        cursor: not-allowed;
      }
      .action-buttons button i.fa-solid.fa-heart {
        color: #ff0000;
      }
      /* Instagram-like like button animation */
      .action-buttons #likeBtn.liked-anim i {
        animation: likePulse 0.3s ease-out;
      }

      @keyframes likePulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.8);
        }
        100% {
          transform: scale(1);
        }
      }

      /* Respect user motion preferences */
      @media (prefers-reduced-motion: reduce) {
        .action-buttons #likeBtn.liked-anim i {
          animation: none;
        }
      }
      .liked-phrases-list .remove-btn i.fa-solid.fa-heart {
        color: #ff0000;
      }
      .comment-actions button:disabled i.fa-solid.fa-heart {
        color: #ff0000;
      }
      .reply {
        margin-left: 20px;
        margin-top: 8px;
        padding: 8px;
        border-left: 2px solid #2e8bc0;
      }
      .pagination {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 10px;
      }
      .pagination button {
        background: #2e8bc0;
        border: none;
        padding: 8px 16px;
        border-radius: 8px;
        color: #fff;
        cursor: pointer;
        transition: 0.3s;
        font-size: 14px;
      }
      .pagination button:disabled {
        background: #ccc;
        color: #666;
        cursor: not-allowed;
      }
      .pagination button:hover:enabled {
        background: #145da0;
      }
      /* Quiz buttons */
      .quiz-option {
        background: #2e8bc0;
        border: none;
        padding: 12px 20px;
        margin: 10px 0;
        border-radius: 8px;
        color: #fff;
        font-size: 15px;
        width: 100%;
        cursor: pointer;
        transition: 0.3s;
      }
      .quiz-option:hover {
        background: #145da0;
      }
      /* Quiz Header */
      .quiz-header {
        font-family: "Montserrat", sans-serif;
        font-size: 20px;
        margin-top: 10px;
        margin-bottom: 10px;
        color: #2e8bc0;
      }
      /* Popup Modal */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
      }
      .modal-content {
        background: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        width: 90%;
        max-width: 280px;
        min-height: 200px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        position: relative;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
      }
      .modal-content.correct-answer .share-icon {
        display: block !important;
      }
      .modal-content.correct-answer .share-text {
        display: block !important;
      }
      .modal-content .banner {
        background: #2e8bc0;
        color: #fff;
        padding: 10px;
        font-family: "Montserrat", sans-serif;
        font-size: 20px;
        font-weight: 600;
        text-align: center;
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
        margin: -20px -20px 20px -20px;
      }
      .modal-content p.tick-item {
        text-align: left;
        margin-bottom: 4px;
        padding-left: 15px;
        display: flex;
        align-items: center;
      }
      .modal-content p.tick-item i {
        color: #2e8bc0;
        margin-right: 20px;
      }
      .modal-content .button-row {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-top: 10px;
      }
      .modal-content button {
        background: #2e8bc0;
        border: none;
        padding: 8px 16px;
        border-radius: 8px;
        color: #fff;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 14px;
      }
      .modal-content button:disabled {
        background: #ccc;
        color: #666;
        cursor: not-allowed;
      }
      .modal-content a.share-icon {
        color: #2e8bc0;
        font-size: 16px;
        cursor: pointer;
        transition: 0.3s;
        text-decoration: none;
        position: absolute;
        top: 50px;
        right: 10px;
        display: none;
      }
      .modal-content a.share-icon:hover {
        color: #145da0;
      }
      .modal-content .share-text {
        position: absolute;
        top: 52px;
        right: 35px;
        font-size: 12px;
        font-style: italic;
        color: #555;
        display: none;
      }
      .modal-content .streak-conditions {
        font-size: 12px;
        font-style: italic;
        color: #555;
        margin-top: 10px;
        text-align: center;
      }
      .medal-bronze {
        color: #cd7f32;
      }
      .medal-silver {
        color: #c0c0c0;
      }
      .medal-gold {
        color: #ffd700;
      }
      .progress-bar {
        width: 100%;
        height: 6px;
        background: #eee;
        margin-top: 10px;
        border-radius: 3px;
        overflow: hidden;
      }
      .progress-fill {
        height: 100%;
        width: 0;
        background: #2e8bc0;
        transition: width 5s linear;
      }
      .modal-content input,
      .modal-content textarea {
        width: 100%;
        padding: 8px;
        margin-bottom: 8px;
        box-sizing: border-box;
	font-size: 16px; /* Prevent mobile zoom */
      }
      .modal-content #popupMessage {
        text-align: center;
      }
      .liked-phrases-list {
        max-height: 300px;
        overflow-y: auto;
        margin-bottom: 10px;
      }
      .liked-phrases-list button {
        background: #2e8bc0;
        color: #fff;
        border: none;
        padding: 10px;
        margin: 5px 0;
        border-radius: 8px;
        width: 100%;
        text-align: left;
        cursor: pointer;
        transition: 0.3s;
        font-size: 14px;
      }
      .liked-phrases-list button:hover {
        background: #145da0;
      }
      .liked-phrases-list .phrase-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        margin: 5px 0;
      }
      .liked-phrases-list .phrase-btn {
        flex: 1;
        background: #2e8bc0;
        color: #fff;
        border: none;
        padding: 10px;
        border-radius: 8px;
        text-align: left;
        cursor: pointer;
        transition: 0.3s;
        font-size: 14px;
      }
      .liked-phrases-list .phrase-btn:hover {
        background: #145da0;
      }
      .liked-phrases-list .remove-btn {
        background: #fff;
        color: #2e8bc0;
        border: none;
        padding: 5px;
        border-radius: 8px;
        cursor: pointer;
        transition: 0.3s;
        font-size: 12px;
        display: flex;
        align-items: center;
        width: 24px;
        justify-content: center;
      }
      .liked-phrases-list .remove-btn:hover {
        background: #145da0;
        color: #fff;
      }
      #cookieConsent a:hover {
        color: #145da0;
      }
      #cookieConsent button:hover {
        background: #145da0;
        color: #fff;
      }
      /* Email Notification Modal Specific Styles */
      .modal-content .input-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        margin-bottom: 5px;
      }
      .modal-content label {
        flex: 1;
        text-align: left;
        font-size: 16px;
        margin: 0;
      }
      .modal-content input[type="checkbox"],
      .modal-content input[type="email"],
      .modal-content select {
        flex: 0 0 auto;
        width: auto;
        margin: 0;
        padding: 5px;
        font-size: 15px;
      }
      .modal-content input[type="email"],
      .modal-content select {
        width: 120px;
      }
      .modal-content p {
        font-size: 16px;
        color: #555;
        text-align: left;
        margin: 5px 0;
      }
    </style>
  </head>
  <body>
    <div id="cookieConsent" style="display: none; position: fixed; bottom: 0; left: 0; right: 0; background: #2e8bc0; color: #fff; padding: 10px; text-align: center; z-index: 1000;">
      <p>We use cookies to track usage and improve your experience. <a href="https://learntrend.github.io/FlyTie/privacy-policy.html" style="color: #fff; text-decoration: underline;">Learn more</a></p>
      <button onclick="acceptCookies()" style="background: #fff; color: #2e8bc0; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; margin-left: 10px;">Accept</button>
      <button onclick="declineCookies()" style="background: #fff; color: #2e8bc0; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; margin-left: 10px;">Decline</button>
    </div>
    <!-- Top Nav -->
    <div class="top-nav">
      <div class="left">
        <button id="logoBtn" onclick="showSection('phrase')" aria-label="View Phrases" class="active">
          <img src="images/logo.png" alt="FlyTie Logo" class="app-logo" />
        </button>
        <button id="quizBtn" onclick="showSection('quiz')" aria-label="View Quiz"><i class="fa-solid fa-dice"></i></button>
        <button id="infoBtn" onclick="showInfo()" aria-label="View App Info"><i class="fa-solid fa-circle-info"></i></button>
        <button id="dropdownBtn" onclick="toggleDropdown()" aria-label="More Options"><i class="fa-solid fa-caret-down"></i></button>
        <div id="dropdownMenu" class="dropdown-menu">
          <button onclick="showStreakPopup()">My Streak</button>
          <button onclick="showLikedPhrasesPopup()">Liked Phrases</button>
          <button onclick="showBookmarkPopup()">My Bookmark</button>
          <button onclick="showContactPopup()">Contact Us</button>
          <button onclick="showEmailNotificationPopup()">Notify me</button>
        </div>
      </div>
      <button onclick="globalShare()" aria-label="Share FlyTie"><i class="fa-solid fa-arrow-up-from-bracket"></i></button>
    </div>
    <!-- Main Content -->
    <div class="main">
      <!-- Phrase Section -->
      <div id="phraseSection">
        <div class="card">
          <div class="quiz-header" id="phraseHeader" style="display: none;">Phrase of the Day</div>
          <h2 id="phraseText">Loading...</h2>
          <p><strong>Meaning:</strong> <span id="meaningText">Loading...</span></p>
          <p><strong>Usage:</strong> <span id="usageText">Loading...</span></p>
          <div class="action-buttons">
            <button id="likeBtn" onclick="toggleLikePhrase()" aria-label="Like this phrase"><i class="fa-regular fa-heart"></i></button>
            <button id="shareBtn" onclick="globalShare()" aria-label="Share this phrase"><i class="fa-solid fa-arrow-up-from-bracket"></i></button>
            <button id="bookmarkBtn" class="bookmark-btn" onclick="toggleBookmark()" aria-label="Bookmark this phrase"><i class="fa-regular fa-bookmark"></i></button>
          </div>
          <!-- Navigation -->
          <div class="nav-buttons">
            <button id="prevPhraseBtn" onclick="prevPhrase()" aria-label="Previous Phrase"><i class="fas fa-chevron-left"></i></button>
            <button id="nextPhraseBtn" onclick="nextPhrase()" aria-label="Next Phrase"><i class="fas fa-chevron-right"></i></button>
          </div>
        </div>
      </div>
      <!-- Quiz Section -->
      <div id="quizSection" style="display: none;">
        <div class="card">
          <div class="quiz-header">Quiz of the Day</div>
          <h2 id="quizTitle">Loading...</h2>
          <div id="quizOptions">
            <!-- Options loaded dynamically -->
          </div>
        </div>
      </div>
      <!-- Comments Section -->
      <div class="comments">
        <div class="comments-header">
          <div class="stats"><i class="fas fa-comment"></i> <span id="commentCount">0</span></div>
          <div class="actions">
            <span>Like FlyTie?</span>
            <button id="commentBtn" aria-label="Add a Comment">Comment</button>
          </div>
        </div>
        <div id="commentList" class="comment-list">
          <!-- Comments loaded dynamically -->
        </div>
        <div class="pagination">
          <button id="prevComments" onclick="prevCommentsPage()" disabled>Previous</button>
          <button id="nextComments" onclick="nextCommentsPage()">Next</button>
        </div>
      </div>
    </div>
    <!-- Modals -->
    <div class="modal" id="popup">
      <div class="modal-content">
        <div class="banner" id="quizBanner"></div>
        <span class="share-text">Share with your friends</span>
        <a id="shareBtn" class="share-icon" onclick="shareResult()" aria-label="Share Quiz Result"><i class="fa-solid fa-arrow-up-from-bracket"></i></a>
        <p id="popupMessage"></p>
        <div class="progress-bar" id="progressBar" style="display: none;">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="button-row" id="popupButtonRow">
          <button id="okBtn" onclick="closePopup()">OK</button>
        </div>
      </div>
    </div>
    <!-- Info Modal -->
    <div class="modal" id="infoPopup" onclick="event.stopPropagation()">
      <div class="modal-content">
        <div class="banner">About FlyTie</div>
        <p class="tick-item"><i class="fa-solid fa-quote-left"></i> Learn new professional phrases daily</p>
        <p class="tick-item"><i class="fa-solid fa-brain"></i> Test your knowledge with fun quizzes</p>
        <p class="tick-item"><i class="fa-solid fa-heart"></i> Like your favorite phrases</p>
        <p class="tick-item"><i class="fa-solid fa-bookmark"></i> Bookmark your phrases to keep track of your progress</p>
        <p class="tick-item"><i class="fa-solid fa-user-group"></i> Share your quiz results with your friends</p>
        <p class="tick-item"><i class="fa-solid fa-comment"></i> Add comments to connect with others</p>
        <p class="tick-item"><i class="fa-solid fa-medal"></i> Check & Share your streak</p>
        <p class="tick-item"><i class="fa-solid fa-bell"></i> Get updated on the new phrases daily</p>
        <div class="button-row">
          <button onclick="closeInfoPopup()">OK</button>
        </div>
      </div>
    </div>
    <!-- Comment Modal -->
    <div class="modal" id="commentPopup">
      <div class="modal-content">
        <div class="banner">Add a Comment</div>
        <input id="username" type="text" placeholder="Your name" />
        <textarea id="commentText" placeholder="Add a comment..."></textarea>
        <div class="button-row">
          <button onclick="submitComment()">Submit</button>
          <button onclick="closeCommentPopup()">Close</button>
        </div>
      </div>
    </div>
    <!-- Reply Modal -->
    <div class="modal" id="replyPopup">
      <div class="modal-content">
        <div class="banner">Reply to Comment</div>
        <input id="replyUsername" type="text" placeholder="Your name" />
        <textarea id="replyText" placeholder="Add a reply..."></textarea>
        <div class="button-row">
          <button onclick="submitReply()">Submit</button>
          <button onclick="closeReplyPopup()">Close</button>
        </div>
      </div>
    </div>
    <!-- Streak Modal -->
    <div class="modal" id="streakPopup">
      <div class="modal-content">
        <div class="banner">Your Streak</div>
        <p id="streakMessage">Your Streak: 0 days 🔥</p>
        <a id="streakShareBtn" class="share-icon" onclick="shareStreak()" aria-label="Share Streak"></a>
        <span class="streak-conditions">Week 1 - Bronze Medal, Week 2 - Silver Medal, Week 3 onwards - Gold Medal</span>
        <div class="button-row">
          <button onclick="shareStreak()">Share</button>
          <button onclick="closeStreakPopup()">OK</button>
        </div>
      </div>
    </div>
    <!-- Liked Phrases Modal -->
    <div class="modal" id="likedPhrasesPopup">
      <div class="modal-content">
        <div class="banner">Liked Phrases</div>
        <div id="likedPhrasesList" class="liked-phrases-list"></div>
        <div class="button-row">
          <button onclick="closeLikedPhrasesPopup()">Close</button>
        </div>
      </div>
    </div>
    <!-- Bookmark Modal -->
    <div class="modal" id="bookmarkPopup">
      <div class="modal-content">
        <div class="banner">Bookmarked Phrase</div>
        <p id="bookmarkMessage">No phrase bookmarked.</p>
        <div id="bookmarkNav" class="button-row" style="display: none;">
          <button onclick="goToBookmark()">Go to Phrase</button>
        </div>
        <div class="button-row">
          <button onclick="closeBookmarkPopup()">Close</button>
        </div>
      </div>
    </div>
    <!-- Contact Us Modal -->
    <div class="modal" id="contactPopup">
      <div class="modal-content">
        <div class="banner">Contact Us</div>
        <p>Have feedback, questions, or ran into an issue? We'd love to hear from you! Reach out to share your thoughts or get help.</p>
        <div class="button-row">
          <a href="mailto:vaada2023@gmail.com" style="text-decoration: none;"><button>Email Us</button></a>
          <button onclick="closeContactPopup()">Close</button>
        </div>
      </div>
    </div>
    <!-- Email Notification Modal -->
    <div class="modal" id="emailNotificationPopup">
      <div class="modal-content">
        <div class="banner">Daily Email Reminders</div>
        <p>Receive a daily email for new phrases!</p>
        <p></p>
        <div class="input-row">
          <label for="enableEmailNotifications">Enable Email Notifications:</label>
          <input type="checkbox" id="enableEmailNotifications" />
        </div>
        <div class="input-row">
          <label for="email">Email Address:</label>
          <input type="email" id="email" placeholder="your@email.com" />
        </div>
        <div class="input-row">
          <label for="notificationTime">Daily Notification Time (24h):</label>
          <select id="notificationTime">
            <option value="00:00">00:00</option>
            <option value="00:15">00:15</option>
            <option value="00:30">00:30</option>
            <option value="00:45">00:45</option>
            <option value="01:00">01:00</option>
            <option value="01:15">01:15</option>
            <option value="01:30">01:30</option>
            <option value="01:45">01:45</option>
            <option value="02:00">02:00</option>
            <option value="02:15">02:15</option>
            <option value="02:30">02:30</option>
            <option value="02:45">02:45</option>
            <option value="03:00">03:00</option>
            <option value="03:15">03:15</option>
            <option value="03:30">03:30</option>
            <option value="03:45">03:45</option>
            <option value="04:00">04:00</option>
            <option value="04:15">04:15</option>
            <option value="04:30">04:30</option>
            <option value="04:45">04:45</option>
            <option value="05:00">05:00</option>
            <option value="05:15">05:15</option>
            <option value="05:30">05:30</option>
            <option value="05:45">05:45</option>
            <option value="06:00">06:00</option>
            <option value="06:15">06:15</option>
            <option value="06:30">06:30</option>
            <option value="06:45">06:45</option>
            <option value="07:00">07:00</option>
            <option value="07:15">07:15</option>
            <option value="07:30">07:30</option>
            <option value="07:45">07:45</option>
            <option value="08:00">08:00</option>
            <option value="08:15">08:15</option>
            <option value="08:30">08:30</option>
            <option value="08:45">08:45</option>
            <option value="09:00">09:00</option>
            <option value="09:15">09:15</option>
            <option value="09:30">09:30</option>
            <option value="09:45">09:45</option>
            <option value="10:00">10:00</option>
            <option value="10:15">10:15</option>
            <option value="10:30">10:30</option>
            <option value="10:45">10:45</option>
            <option value="11:00">11:00</option>
            <option value="11:15">11:15</option>
            <option value="11:30">11:30</option>
            <option value="11:45">11:45</option>
            <option value="12:00">12:00</option>
            <option value="12:15">12:15</option>
            <option value="12:30">12:30</option>
            <option value="12:45">12:45</option>
            <option value="13:00">13:00</option>
            <option value="13:15">13:15</option>
            <option value="13:30">13:30</option>
            <option value="13:45">13:45</option>
            <option value="14:00">14:00</option>
            <option value="14:15">14:15</option>
            <option value="14:30">14:30</option>
            <option value="14:45">14:45</option>
            <option value="15:00">15:00</option>
            <option value="15:15">15:15</option>
            <option value="15:30">15:30</option>
            <option value="15:45">15:45</option>
            <option value="16:00">16:00</option>
            <option value="16:15">16:15</option>
            <option value="16:30">16:30</option>
            <option value="16:45">16:45</option>
            <option value="17:00">17:00</option>
            <option value="17:15">17:15</option>
            <option value="17:30">17:30</option>
            <option value="17:45">17:45</option>
            <option value="18:00">18:00</option>
            <option value="18:15">18:15</option>
            <option value="18:30">18:30</option>
            <option value="18:45">18:45</option>
            <option value="19:00">19:00</option>
            <option value="19:15">19:15</option>
            <option value="19:30">19:30</option>
            <option value="19:45">19:45</option>
            <option value="20:00">20:00</option>
            <option value="20:15">20:15</option>
            <option value="20:30">20:30</option>
            <option value="20:45">20:45</option>
            <option value="21:00">21:00</option>
            <option value="21:15">21:15</option>
            <option value="21:30">21:30</option>
            <option value="21:45">21:45</option>
            <option value="22:00">22:00</option>
            <option value="22:15">22:15</option>
            <option value="22:30">22:30</option>
            <option value="22:45">22:45</option>
            <option value="23:00">23:00</option>
            <option value="23:15">23:15</option>
            <option value="23:30">23:30</option>
            <option value="23:45">23:45</option>
          </select>
        </div>
        <p>Your email is used only for reminders and stored securely.</p>
        <div class="button-row">
          <button onclick="saveEmailNotificationSettings()">Save</button>
          <button onclick="closeEmailNotificationPopup()">Cancel</button>
        </div>
      </div>
    </div>
<script>
  let quizStartTime = null;
  let phrases = [];
  let quizzes = [];
  let currentIndex = 0;
  let currentCommentId = null;
  let currentCommentPage = 0;
  const commentsPerPage = 10;
  const PHRASES_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSx3wQD_d33uZsOTPlmRddf01gml1iuRiAMLyvGVk9U-Kv2-F5zIGUuSBuOBgu2O36ntNUD4KlaYhoZ/pub?output=csv";
  const QUIZ_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSx3wQD_d33uZsOTPlmRddf01gml1iuRiAMLyvGVk9U-Kv2-F5zIGUuSBuOBgu2O36ntNUD4KlaYhoZ/pub?gid=102179282&single=true&output=csv";
  const COMMENT_URL = "https://script.google.com/macros/s/AKfycbyCXstLVsrwJyWjDRCYUtaTr1kwPjejBm8-V8WO6mTR5wt0T1n-bDJtlFfyJx-jflFWMw/exec";

  function acceptCookies() {
    localStorage.setItem("cookieConsent", "accepted");
    document.getElementById("cookieConsent").style.display = "none";
    gtag("consent", "update", { analytics_storage: "granted" });
  }

  function declineCookies() {
    localStorage.setItem("cookieConsent", "denied");
    document.getElementById("cookieConsent").style.display = "none";
    gtag("consent", "update", { analytics_storage: "denied" });
  }

  if (!localStorage.getItem("cookieConsent")) {
    document.getElementById("cookieConsent").style.display = "block";
  } else if (localStorage.getItem("cookieConsent") === "accepted") {
    gtag("consent", "update", { analytics_storage: "granted" });
  }

  async function fetchWithRetry(url, options = {}, retries = 3, delay = 3000) {
    for (let i = 0; i < retries; i++) {
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);
        const res = await fetch(url, { ...options, signal: controller.signal });
        clearTimeout(timeoutId);
        if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
        const contentType = res.headers.get("content-type") || "";
        if (contentType.includes("application/json")) {
          return await res.json();
        } else if (contentType.includes("text/csv") || contentType.includes("text/plain")) {
          return await res.text();
        } else {
          throw new Error("Unexpected content type: " + contentType);
        }
      } catch (e) {
        if (i === retries - 1) throw e;
        console.warn(`Fetch attempt ${i + 1} failed for ${url}: ${e.message}. Retrying...`);
        await new Promise((resolve) => setTimeout(resolve, delay));
      }
    }
  }

  async function fetchUserLikes(userId) {
    try {
      const response = await fetchWithRetry(`${COMMENT_URL}?action=getUserLikes&userId=${encodeURIComponent(userId)}`);
      if (response.status === "success") {
        return response.likes || [];
      } else {
        console.error("Error fetching user likes:", response.message);
        return [];
      }
    } catch (e) {
      console.error("Error fetching user likes:", e);
      return [];
    }
  }

  function updateStreak() {
    const today = new Date().toDateString();
    const lastVisit = localStorage.getItem("lastVisit");
    let streak = parseInt(localStorage.getItem("streak")) || 0;
    if (!lastVisit) {
      streak = 1;
    } else {
      const lastVisitDate = new Date(lastVisit);
      const yesterday = new Date();
      yesterday.setDate(new Date().getDate() - 1);
      if (lastVisit === today) {
        streak = streak;
      } else if (lastVisitDate.toDateString() === yesterday.toDateString()) {
        streak += 1;
      } else {
        streak = 1;
      }
    }
    localStorage.setItem("streak", streak);
    localStorage.setItem("lastVisit", today);
    return streak;
  }

  function toggleDropdown() {
    const dropdownMenu = document.getElementById("dropdownMenu");
    const isOpen = dropdownMenu.style.display === "block";
    dropdownMenu.style.display = isOpen ? "none" : "block";
    if (!isOpen) {
      document.addEventListener("click", closeDropdownOnOutsideClick);
    } else {
      document.removeEventListener("click", closeDropdownOnOutsideClick);
    }
  }

  function closeDropdownOnOutsideClick(event) {
    const dropdownMenu = document.getElementById("dropdownMenu");
    const dropdownBtn = document.getElementById("dropdownBtn");
    if (!dropdownMenu.contains(event.target) && !dropdownBtn.contains(event.target)) {
      dropdownMenu.style.display = "none";
      document.removeEventListener("click", closeDropdownOnOutsideClick);
    }
  }

  function showContactPopup() {
    toggleDropdown();
    document.getElementById("contactPopup").style.display = "flex";
    document.body.classList.add("no-scroll");
  }

  function closeContactPopup() {
    document.getElementById("contactPopup").style.display = "none";
    document.body.classList.remove("no-scroll");
  }

  function showEmailNotificationPopup() {
    toggleDropdown();
    document.getElementById("emailNotificationPopup").style.display = "flex";
    document.body.classList.add("no-scroll");
    const settings = JSON.parse(localStorage.getItem("emailNotificationSettings") || "{}");
    document.getElementById("enableEmailNotifications").checked = settings.enabled || false;
    document.getElementById("email").value = settings.email || "";
    document.getElementById("notificationTime").value = settings.time || "09:00";
  }

  function closeEmailNotificationPopup() {
    document.getElementById("emailNotificationPopup").style.display = "none";
    document.body.classList.remove("no-scroll");
  }

  async function saveEmailNotificationSettings() {
    const enabled = document.getElementById("enableEmailNotifications").checked;
    const email = document.getElementById("email").value;
    const time = document.getElementById("notificationTime").value;
    if (enabled && !email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
      alert("Please enter a valid email address.");
      return;
    }
    const settings = { enabled, email, time };
    localStorage.setItem("emailNotificationSettings", JSON.stringify(settings));
    const userId = generateUserId();
    try {
      const response = await fetchWithRetry(`${COMMENT_URL}?action=saveEmail`, {
        method: "POST",
        body: new URLSearchParams({
          userId,
          email,
          time,
          enabled: enabled.toString(),
        }),
      });
      if (response.status !== "success") {
        throw new Error(response.message || "Failed to save email settings");
      }
      if (localStorage.getItem("cookieConsent") === "accepted") {
        gtag("event", "notification_subscription", {
          type: "email",
          event_category: "engagement",
          event_label: enabled ? "Email Notification Enabled" : "Email Notification Disabled",
        });
      }
      alert("Email notifications saved! You'll receive reminders as scheduled.");
      closeEmailNotificationPopup();
    } catch (e) {
      console.error("Error saving notification settings:", e);
      alert("Failed to save settings: " + e.message);
    }
  }

  function generateUserId() {
    let userId = localStorage.getItem("userId");
    if (!userId) {
      userId = "user_" + Date.now() + "_" + Math.random().toString(36).substr(2, 9);
      localStorage.setItem("userId", userId);
    }
    return userId;
  }

  function showStreakPopup() {
    toggleDropdown();
    const streak = parseInt(localStorage.getItem("streak")) || 0;
    const streakMessage = document.getElementById("streakMessage");
    const streakConditions = document.querySelector("#streakPopup .streak-conditions");
    const streakShareBtn = document.getElementById("streakShareBtn");
    if (streak > 0) {
      streakMessage.innerHTML = `Your Streak: ${streak} day${streak !== 1 ? "s" : ""}!<br>You earned a badge <i class="fa-solid fa-medal"></i>`;
      const medalIcon = streakMessage.querySelector("i");
      medalIcon.classList.remove("medal-bronze", "medal-silver", "medal-gold");
      if (streak >= 1 && streak <= 7) {
        medalIcon.classList.add("medal-bronze");
      } else if (streak >= 8 && streak <= 14) {
        medalIcon.classList.add("medal-silver");
      } else if (streak >= 15) {
        medalIcon.classList.add("medal-gold");
      }
      streakConditions.style.display = "block";
      streakShareBtn.style.display = "inline-block";
    } else {
      streakMessage.innerHTML = `Your Streak: 0 days 🔥`;
      streakConditions.style.display = "none";
      streakShareBtn.style.display = "none";
    }
    document.getElementById("streakPopup").style.display = "flex";
    document.body.classList.add("no-scroll");
  }

  function closeStreakPopup() {
    document.getElementById("streakPopup").style.display = "none";
    document.body.classList.remove("no-scroll");
  }

  function shareStreak() {
    const streak = parseInt(localStorage.getItem("streak")) || 0;
    if (navigator.share) {
      navigator
        .share({
          title: "FlyTie - My Streak",
          text: `I've kept a ${streak} day streak on FlyTie! 🔥`,
          url: window.location.href,
        })
        .then(() => {
          if (localStorage.getItem("cookieConsent") === "accepted") {
            gtag("event", "share_streak", {
              streak_length: streak,
              event_category: "engagement",
              event_label: "Streak Shared",
            });
          }
        })
        .catch((err) => {
          if (err.name === "AbortError" || err.name === "NotAllowedError" || err.message.toLowerCase().includes("cancel")) {
            return;
          }
          console.error("Error sharing streak:", err);
          alert("Error sharing streak: An unexpected error occurred. Please try again.");
        });
    } else {
      alert("Sharing not supported on this browser.");
    }
  }

  async function showLikedPhrasesPopup() {
    toggleDropdown();
    const userId = generateUserId();
    const likedPhrases = JSON.parse(localStorage.getItem("likedPhrases") || "[]");
    const likedPhrasesList = document.getElementById("likedPhrasesList");
    likedPhrasesList.innerHTML = "";
    if (likedPhrases.length === 0) {
      likedPhrasesList.innerHTML = "<p>No liked phrases.</p>";
    } else {
      likedPhrases.forEach((phrase, index) => {
        const container = document.createElement("div");
        container.className = "phrase-container";
        const btn = document.createElement("button");
        btn.className = "phrase-btn";
        btn.textContent = phrase;
        btn.onclick = () => {
          const phraseIndex = phrases.findIndex((p) => p.phrase === phrase);
          if (phraseIndex !== -1) {
            currentIndex = phraseIndex;
            closeLikedPhrasesPopup();
            showSection("phrase");
            showPhrase();
          }
        };
        const removeBtn = document.createElement("button");
        removeBtn.className = "remove-btn";
        removeBtn.innerHTML = '<i class="fa-solid fa-heart"></i>';
        removeBtn.onclick = () => removeLikedPhrase(phrase);
        container.appendChild(btn);
        container.appendChild(removeBtn);
        likedPhrasesList.appendChild(container);
      });
    }
    document.getElementById("likedPhrasesPopup").style.display = "flex";
    document.body.classList.add("no-scroll");
  }

  async function removeLikedPhrase(phrase) {
    const userId = generateUserId();
    let likedPhrases = JSON.parse(localStorage.getItem("likedPhrases") || "[]");
    likedPhrases = likedPhrases.filter((p) => p !== phrase);
    localStorage.setItem("likedPhrases", JSON.stringify(likedPhrases));
    try {
      const response = await fetchWithRetry(`${COMMENT_URL}?action=removeLike`, {
        method: "POST",
        body: new URLSearchParams({
          phrase: phrase,
          userId: userId,
        }),
      });
      if (response.status !== "success") {
        throw new Error(response.message || "Failed to unlike phrase");
      }
      if (phrases[currentIndex]?.phrase === phrase) {
        const likeBtn = document.getElementById("likeBtn");
        likeBtn.innerHTML = '<i class="fa-regular fa-heart"></i>';
        likeBtn.classList.remove("liked-anim");
      }
      showLikedPhrasesPopup();
      updateLikeButton();
      if (localStorage.getItem("cookieConsent") === "accepted") {
        gtag("event", "unlike_phrase", {
          phrase: phrase,
          event_category: "engagement",
          event_label: "Phrase Unliked",
        });
      }
    } catch (e) {
      console.error("Error removing like:", e);
      alert("Failed to unlike phrase: " + e.message);
      likedPhrases.push(phrase);
      localStorage.setItem("likedPhrases", JSON.stringify(likedPhrases));
      showLikedPhrasesPopup();
    }
  }

  function closeLikedPhrasesPopup() {
    document.getElementById("likedPhrasesPopup").style.display = "none";
    document.body.classList.remove("no-scroll");
  }

  function showBookmarkPopup() {
    toggleDropdown();
    const bookmarkedPhrase = localStorage.getItem("bookmarkedPhrase");
    const bookmarkMessage = document.getElementById("bookmarkMessage");
    const bookmarkNav = document.getElementById("bookmarkNav");
    if (bookmarkedPhrase) {
      bookmarkMessage.textContent = `Bookmarked: ${bookmarkedPhrase}`;
      bookmarkNav.style.display = "flex";
    } else {
      bookmarkMessage.textContent = "No phrase bookmarked.";
      bookmarkNav.style.display = "none";
    }
    document.getElementById("bookmarkPopup").style.display = "flex";
    document.body.classList.add("no-scroll");
  }

  function closeBookmarkPopup() {
    document.getElementById("bookmarkPopup").style.display = "none";
    document.body.classList.remove("no-scroll");
  }

  function goToBookmark() {
    const bookmarkedPhrase = localStorage.getItem("bookmarkedPhrase");
    if (bookmarkedPhrase) {
      const phraseIndex = phrases.findIndex((p) => p.phrase === bookmarkedPhrase);
      if (phraseIndex !== -1) {
        currentIndex = phraseIndex;
        showSection("phrase");
        showPhrase();
        closeBookmarkPopup();
      } else {
        alert("Bookmarked phrase not found in current phrases.");
      }
    }
  }

  async function toggleLikePhrase() {
    const phrase = phrases[currentIndex]?.phrase;
    if (!phrase) return;
    const userId = generateUserId();
    let likedPhrases = JSON.parse(localStorage.getItem("likedPhrases") || "[]");
    const likeBtn = document.getElementById("likeBtn");
    const isLiked = likedPhrases.includes(phrase);
    try {
      if (isLiked) {
        const response = await fetchWithRetry(`${COMMENT_URL}?action=removeLike`, {
          method: "POST",
          body: new URLSearchParams({
            phrase: phrase,
            userId: userId,
          }),
        });
        if (response.status !== "success") {
          throw new Error(response.message || "Failed to unlike phrase");
        }
        likedPhrases = likedPhrases.filter((p) => p !== phrase);
        likeBtn.innerHTML = '<i class="fa-regular fa-heart"></i>';
        likeBtn.classList.remove("liked-anim");
        if (localStorage.getItem("cookieConsent") === "accepted") {
          gtag("event", "unlike_phrase", {
            phrase: phrase,
            event_category: "engagement",
            event_label: "Phrase Unliked",
          });
        }
      } else {
        const response = await fetchWithRetry(`${COMMENT_URL}?action=addLike`, {
          method: "POST",
          body: new URLSearchParams({
            phrase: phrase,
            userId: userId,
          }),
        });
        if (response.status !== "success") {
          throw new Error(response.message || "Failed to like phrase");
        }
        likedPhrases.push(phrase);
        likeBtn.innerHTML = '<i class="fa-solid fa-heart"></i>';
        likeBtn.classList.add("liked-anim");
        setTimeout(() => likeBtn.classList.remove("liked-anim"), 300);
        if (localStorage.getItem("cookieConsent") === "accepted") {
          gtag("event", "like_phrase", {
            phrase: phrase,
            event_category: "engagement",
            event_label: "Phrase Liked",
          });
        }
      }
      localStorage.setItem("likedPhrases", JSON.stringify(likedPhrases));
      updateLikeButton();
    } catch (e) {
      console.error("Error toggling like:", e);
      alert("Failed to toggle like: " + e.message);
    }
  }

  function toggleBookmark() {
    const phrase = phrases[currentIndex]?.phrase;
    if (!phrase) return;
    const bookmarkBtn = document.getElementById("bookmarkBtn");
    const currentBookmark = localStorage.getItem("bookmarkedPhrase");
    if (currentBookmark === phrase) {
      localStorage.removeItem("bookmarkedPhrase");
      bookmarkBtn.classList.remove("bookmarked");
      bookmarkBtn.innerHTML = '<i class="fa-regular fa-bookmark"></i>';
      if (localStorage.getItem("cookieConsent") === "accepted") {
        gtag("event", "remove_bookmark", {
          phrase: phrase,
          event_category: "engagement",
          event_label: "Bookmark Removed",
        });
      }
    } else {
      localStorage.setItem("bookmarkedPhrase", phrase);
      bookmarkBtn.classList.add("bookmarked");
      bookmarkBtn.innerHTML = '<i class="fa-solid fa-bookmark"></i>';
      if (localStorage.getItem("cookieConsent") === "accepted") {
        gtag("event", "add_bookmark", {
          phrase: phrase,
          event_category: "engagement",
          event_label: "Bookmark Added",
        });
      }
    }
  }

  function showSection(section) {
    document.getElementById("phraseSection").style.display = section === "phrase" ? "block" : "none";
    document.getElementById("quizSection").style.display = section === "quiz" ? "block" : "none";
    document.getElementById("logoBtn").classList.toggle("active", section === "phrase");
    document.getElementById("quizBtn").classList.toggle("active", section === "quiz");
    toggleDropdown();
    if (section === "phrase") {
      showPhrase();
    } else if (section === "quiz") {
      showQuiz();
    }
  }

  function showInfo() {
    toggleDropdown();
    document.getElementById("infoPopup").style.display = "flex";
    document.body.classList.add("no-scroll");
  }

  function closeInfoPopup() {
    document.getElementById("infoPopup").style.display = "none";
    document.body.classList.remove("no-scroll");
  }

  async function globalShare() {
    const section = document.getElementById("phraseSection").style.display === "block" ? "phrase" : "quiz";
    let title, text;
    if (section === "phrase") {
      const phrase = phrases[currentIndex]?.phrase;
      title = "FlyTie - Phrase of the Day";
      text = `Check out today's phrase on FlyTie: "${phrase}"!`;
    } else {
      title = "FlyTie - Quiz of the Day";
      text = "Test your knowledge with today's quiz on FlyTie!";
    }
    if (navigator.share) {
      try {
        await navigator.share({
          title: title,
          text: text,
          url: window.location.href,
        });
        if (localStorage.getItem("cookieConsent") === "accepted") {
          gtag("event", "share_content", {
            content_type: section,
            event_category: "engagement",
            event_label: `${section === "phrase" ? "Phrase" : "Quiz"} Shared`,
          });
        }
      } catch (err) {
        if (err.name === "AbortError" || err.name === "NotAllowedError" || err.message.toLowerCase().includes("cancel")) {
          return;
        }
        console.error("Error sharing:", err);
        alert("Error sharing: An unexpected error occurred. Please try again.");
      }
    } else {
      alert("Sharing not supported on this browser.");
    }
  }

  async function shareResult() {
    const quiz = quizzes[currentIndex];
    if (!quiz) return;
    const title = "FlyTie - Quiz Result";
    const text = `I got the quiz right on FlyTie! Can you answer this: ${quiz.question}?`;
    if (navigator.share) {
      try {
        await navigator.share({
          title: title,
          text: text,
          url: window.location.href,
        });
        if (localStorage.getItem("cookieConsent") === "accepted") {
          gtag("event", "share_quiz_result", {
            quiz_question: quiz.question,
            event_category: "engagement",
            event_label: "Quiz Result Shared",
          });
        }
      } catch (err) {
        if (err.name === "AbortError" || err.name === "NotAllowedError" || err.message.toLowerCase().includes("cancel")) {
          return;
        }
        console.error("Error sharing quiz result:", err);
        alert("Error sharing quiz result: An unexpected error occurred. Please try again.");
      }
    } else {
      alert("Sharing not supported on this browser.");
    }
  }

  function parseCSV(csvText) {
    const rows = [];
    let currentRow = [];
    let currentCell = "";
    let inQuotes = false;
    for (let i = 0; i < csvText.length; i++) {
      const char = csvText[i];
      if (char === '"') {
        inQuotes = !inQuotes;
      } else if (char === "," && !inQuotes) {
        currentRow.push(currentCell.trim());
        currentCell = "";
      } else if (char === "\n" && !inQuotes) {
        currentRow.push(currentCell.trim());
        rows.push(currentRow);
        currentRow = [];
        currentCell = "";
      } else {
        currentCell += char;
      }
    }
    currentRow.push(currentCell.trim());
    if (currentRow.length > 1 || currentRow[0]) {
      rows.push(currentRow);
    }
    return rows;
  }

  async function loadPhrases() {
    try {
      const csvText = await fetchWithRetry(PHRASES_CSV_URL);
      const rows = parseCSV(csvText);
      phrases = rows.slice(1).map((row) => ({
        phrase: row[0],
        meaning: row[1],
        usage: row[2],
      }));
      currentIndex = Math.min(currentIndex, phrases.length - 1);
      showPhrase();
      const userId = generateUserId();
      const serverLikes = await fetchUserLikes(userId);
      let likedPhrases = JSON.parse(localStorage.getItem("likedPhrases") || "[]");
      likedPhrases = [...new Set([...likedPhrases, ...serverLikes])].filter((p) => phrases.some((phrase) => phrase.phrase === p));
      localStorage.setItem("likedPhrases", JSON.stringify(likedPhrases));
      updateLikeButton();
    } catch (e) {
      console.error("Error loading phrases:", e);
      document.getElementById("phraseText").textContent = "Error loading phrase.";
      document.getElementById("meaningText").textContent = "";
      document.getElementById("usageText").textContent = "";
    }
  }

  async function loadQuizzes() {
    try {
      const csvText = await fetchWithRetry(QUIZ_CSV_URL);
      const rows = parseCSV(csvText);
      quizzes = rows.slice(1).map((row) => ({
        question: row[0],
        options: [row[1], row[2], row[3], row[4]],
        answer: row[1],
      }));
      showQuiz();
    } catch (e) {
      console.error("Error loading quizzes:", e);
      document.getElementById("quizTitle").textContent = "Error loading quiz.";
      document.getElementById("quizOptions").innerHTML = "";
    }
  }

  function showPhrase() {
    if (phrases.length === 0) return;
    const phrase = phrases[currentIndex];
    document.getElementById("phraseHeader").style.display = "block";
    document.getElementById("phraseText").textContent = phrase.phrase;
    document.getElementById("meaningText").textContent = phrase.meaning;
    document.getElementById("usageText").textContent = phrase.usage;
    document.getElementById("prevPhraseBtn").disabled = currentIndex === 0;
    document.getElementById("nextPhraseBtn").disabled = currentIndex === phrases.length - 1;
    updateLikeButton();
    updateBookmarkButton();
    loadComments();
  }

  function updateLikeButton() {
    const phrase = phrases[currentIndex]?.phrase;
    const likedPhrases = JSON.parse(localStorage.getItem("likedPhrases") || "[]");
    const likeBtn = document.getElementById("likeBtn");
    if (likedPhrases.includes(phrase)) {
      likeBtn.innerHTML = '<i class="fa-solid fa-heart"></i>';
    } else {
      likeBtn.innerHTML = '<i class="fa-regular fa-heart"></i>';
    }
  }

  function updateBookmarkButton() {
    const phrase = phrases[currentIndex]?.phrase;
    const bookmarkBtn = document.getElementById("bookmarkBtn");
    const bookmarkedPhrase = localStorage.getItem("bookmarkedPhrase");
    if (bookmarkedPhrase === phrase) {
      bookmarkBtn.classList.add("bookmarked");
      bookmarkBtn.innerHTML = '<i class="fa-solid fa-bookmark"></i>';
    } else {
      bookmarkBtn.classList.remove("bookmarked");
      bookmarkBtn.innerHTML = '<i class="fa-regular fa-bookmark"></i>';
    }
  }

  function prevPhrase() {
    if (currentIndex > 0) {
      currentIndex--;
      showPhrase();
    }
  }

  function nextPhrase() {
    if (currentIndex < phrases.length - 1) {
      currentIndex++;
      showPhrase();
    }
  }

  function showQuiz() {
    if (quizzes.length === 0) return;
    const quiz = quizzes[currentIndex];
    document.getElementById("quizTitle").textContent = quiz.question;
    const quizOptions = document.getElementById("quizOptions");
    quizOptions.innerHTML = "";
    quiz.options.forEach((option, index) => {
      const btn = document.createElement("button");
      btn.className = "quiz-option";
      btn.textContent = option;
      btn.onclick = () => checkAnswer(option, quiz.answer);
      quizOptions.appendChild(btn);
    });
    quizStartTime = new Date();
  }

  function checkAnswer(selected, correct) {
    const isCorrect = selected === correct;
    const popup = document.getElementById("popup");
    const popupMessage = document.getElementById("popupMessage");
    const quizBanner = document.getElementById("quizBanner");
    const shareBtn = document.getElementById("shareBtn");
    const progressBar = document.getElementById("progressBar");
    const progressFill = document.getElementById("progressFill");
    const popupButtonRow = document.getElementById("popupButtonRow");
    quizBanner.textContent = isCorrect ? "Correct!" : "Incorrect!";
    popupMessage.textContent = isCorrect
      ? "Great job! You got it right."
      : `The correct answer was: ${correct}`;
    popup.classList.toggle("correct-answer", isCorrect);
    shareBtn.style.display = isCorrect ? "inline-block" : "none";
    document.querySelector(".share-text").style.display = isCorrect ? "block" : "none";
    popup.style.display = "flex";
    document.body.classList.add("no-scroll");
    progressBar.style.display = "block";
    progressFill.style.width = "100%";
    setTimeout(() => {
      progressFill.style.width = "0%";
      setTimeout(() => {
        closePopup();
        if (isCorrect) {
          updateStreak();
        }
      }, 5000);
    }, 100);
    if (localStorage.getItem("cookieConsent") === "accepted") {
      const timeTaken = (new Date() - quizStartTime) / 1000;
      gtag("event", "quiz_answer", {
        question: quizzes[currentIndex].question,
        correct: isCorrect,
        time_taken: timeTaken,
        event_category: "engagement",
        event_label: isCorrect ? "Quiz Correct" : "Quiz Incorrect",
      });
    }
  }

  function closePopup() {
    document.getElementById("popup").style.display = "none";
    document.getElementById("progressBar").style.display = "none";
    document.getElementById("progressFill").style.width = "0%";
    document.body.classList.remove("no-scroll");
  }

  async function loadComments() {
    try {
      const response = await fetchWithRetry(`${COMMENT_URL}?action=getComments`);
      if (response.status === "success") {
        const comments = response.comments || [];
        document.getElementById("commentCount").textContent = comments.length;
        displayComments(comments);
      } else {
        console.error("Error fetching comments:", response.message);
        document.getElementById("commentList").innerHTML = "<p>Error loading comments.</p>";
      }
    } catch (e) {
      console.error("Error loading comments:", e);
      document.getElementById("commentList").innerHTML = "<p>Error loading comments.</p>";
    }
  }

  function displayComments(comments) {
    const commentList = document.getElementById("commentList");
    commentList.innerHTML = "";
    const start = currentCommentPage * commentsPerPage;
    const end = start + commentsPerPage;
    const paginatedComments = comments.slice(start, end);
    if (paginatedComments.length === 0 && currentCommentPage > 0) {
      currentCommentPage--;
      displayComments(comments);
      return;
    }
    paginatedComments.forEach((comment) => {
      const div = document.createElement("div");
      div.className = "comment";
      div.innerHTML = `
        <strong>${comment.username}</strong>
        <p>${comment.comment}</p>
        <div class="comment-actions">
          <button onclick="likeComment('${comment.id}', false)" aria-label="Like this comment">
            <i class="fa-solid fa-heart"></i> ${comment.likes || 0}
          </button>
          <button onclick="showReplyPopup('${comment.id}')" aria-label="Reply to this comment">
            <i class="fa-solid fa-reply"></i> Reply
          </button>
        </div>
      `;
      if (comment.replies && comment.replies.length > 0) {
        comment.replies.forEach((reply) => {
          const replyDiv = document.createElement("div");
          replyDiv.className = "reply";
          replyDiv.innerHTML = `
            <strong>${reply.reply.split(": ")[0]}</strong>
            <p>${reply.reply.split(": ").slice(1).join(": ")}</p>
            <div class="comment-actions">
              <button onclick="likeComment('${reply.id}', true)" aria-label="Like this reply">
                <i class="fa-solid fa-heart"></i> ${reply.likes || 0}
              </button>
            </div>
          `;
          div.appendChild(replyDiv);
        });
      }
      commentList.appendChild(div);
    });
    document.getElementById("prevComments").disabled = currentCommentPage === 0;
    document.getElementById("nextComments").disabled = end >= comments.length;
  }

  function prevCommentsPage() {
    if (currentCommentPage > 0) {
      currentCommentPage--;
      loadComments();
    }
  }

  function nextCommentsPage() {
    currentCommentPage++;
    loadComments();
  }

  async function likeComment(commentId, isReply) {
    try {
      const response = await fetchWithRetry(`${COMMENT_URL}?action=addCommentLike&commentId=${commentId}&isReply=${isReply}`, {
        method: "POST",
      });
      if (response.status === "success") {
        loadComments();
        if (localStorage.getItem("cookieConsent") === "accepted") {
          gtag("event", "like_comment", {
            comment_id: commentId,
            is_reply: isReply,
            event_category: "engagement",
            event_label: isReply ? "Reply Liked" : "Comment Liked",
          });
        }
      } else {
        console.error("Error liking comment:", response.message);
        alert("Failed to like comment: " + response.message);
      }
    } catch (e) {
      console.error("Error liking comment:", e);
      alert("Failed to like comment: " + e.message);
    }
  }

  function showCommentPopup() {
    document.getElementById("commentPopup").style.display = "flex";
    document.body.classList.add("no-scroll");
    document.getElementById("username").value = "";
    document.getElementById("commentText").value = "";
  }

  function closeCommentPopup() {
    document.getElementById("commentPopup").style.display = "none";
    document.body.classList.remove("no-scroll");
  }

  function showReplyPopup(commentId) {
    currentCommentId = commentId;
    document.getElementById("replyPopup").style.display = "flex";
    document.body.classList.add("no-scroll");
    document.getElementById("replyUsername").value = "";
    document.getElementById("replyText").value = "";
  }

  function closeReplyPopup() {
    document.getElementById("replyPopup").style.display = "none";
    document.body.classList.remove("no-scroll");
    currentCommentId = null;
  }

  async function submitComment() {
    const username = document.getElementById("username").value.trim();
    const comment = document.getElementById("commentText").value.trim();
    if (!username || !comment) {
      alert("Please enter both your name and a comment.");
      return;
    }
    try {
      const response = await fetchWithRetry(`${COMMENT_URL}?action=addComment`, {
        method: "POST",
        body: new URLSearchParams({
          username,
          comment,
          timestamp: new Date().toISOString(),
        }),
      });
      if (response.status === "success") {
        closeCommentPopup();
        loadComments();
        if (localStorage.getItem("cookieConsent") === "accepted") {
          gtag("event", "add_comment", {
            comment_id: response.id,
            event_category: "engagement",
            event_label: "Comment Added",
          });
        }
      } else {
        console.error("Error submitting comment:", response.message);
        alert("Failed to submit comment: " + response.message);
      }
    } catch (e) {
      console.error("Error submitting comment:", e);
      alert("Failed to submit comment: " + e.message);
    }
  }

  async function submitReply() {
    const username = document.getElementById("replyUsername").value.trim();
    const reply = document.getElementById("replyText").value.trim();
    if (!username || !reply || !currentCommentId) {
      alert("Please enter both your name and a reply.");
      return;
    }
    try {
      const response = await fetchWithRetry(`${COMMENT_URL}?action=addReply`, {
        method: "POST",
        body: new URLSearchParams({
          username,
          comment: reply,
          parentId: currentCommentId,
          timestamp: new Date().toISOString(),
        }),
      });
      if (response.status === "success") {
        closeReplyPopup();
        loadComments();
        if (localStorage.getItem("cookieConsent") === "accepted") {
          gtag("event", "add_reply", {
            comment_id: currentCommentId,
            reply_id: response.id,
            event_category: "engagement",
            event_label: "Reply Added",
          });
        }
      } else {
        console.error("Error submitting reply:", response.message);
        alert("Failed to submit reply: " + response.message);
      }
    } catch (e) {
      console.error("Error submitting reply:", e);
      alert("Failed to submit reply: " + e.message);
    }
  }

  document.getElementById("commentBtn").onclick = showCommentPopup;

  window.onload = () => {
    updateStreak();
    loadPhrases();
    loadQuizzes();
    loadComments();
  };
</script>
  </body>
</html>