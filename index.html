<!DOCTYPE html>
<html lang="en">
   <head>
      <!-- Google tag (gtag.js) -->
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-MG8CHP26VF"></script>
      <script>
         window.dataLayer = window.dataLayer || [];
         function gtag(){dataLayer.push(arguments);}
         gtag('js', new Date());
         gtag('config', 'G-MG8CHP26VF');
      </script>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Word of the Day</title>
      <!-- Open Graph Meta Tags for Share Preview -->
      <meta property="og:title" content="FlyTie - Phrase of the Day">
      <meta property="og:description" content="Learn new professional phrases daily with FlyTie!">
      <meta property="og:image" content="https://learntrend.github.io/images/logo.png">
      <meta property="og:image:type" content="image/png">
      <meta property="og:image:width" content="200">
      <meta property="og:image:height" content="200">
      <meta property="og:url" content="https://learntrend.github.io">
      <meta property="og:type" content="website">
      <!-- Favicon -->
      <link rel="icon" href="images/logo.png">
      <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600&family=Open+Sans&display=swap" rel="stylesheet">
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
      <style>
         body {
         margin: 0;
         font-family: 'Open Sans', sans-serif;
         background-color: #f4f6fb;
         color: #222;
         display: flex;
         height: 100vh;
         flex-direction: column;
         }
         body.no-scroll {
         overflow: hidden;
         }
         /* Top Nav */
         .top-nav {
         display: flex;
         justify-content: space-between;
         align-items: center;
         background: #2E8BC0;
         padding: 10px 20px;
         padding-left: 05px;
         color: #fff;
         }
         .top-nav .left {
         display: flex;
         gap: 05px;
         align-items: center;
         position: relative;
         }
         .app-logo {
         height: 25px;
         max-width: 180px;
         object-fit: contain;
         }
         .top-nav button {
         background: #fff;
         color: #2E8BC0;
         border: none;
         padding: 12px 15px;
         border-radius: 8px;
         font-weight: bold;
         cursor: pointer;
         transition: 0.3s;
         font-size: 16px;
         line-height: 16px;
         display: flex;
         align-items: center;
         gap: 5px;
         }
         #logoBtn {
         padding: 7.5px 10px;
         }
         .top-nav button:disabled {
         background: #ccc;
         color: #666;
         cursor: not-allowed;
         }
         .top-nav button:hover:enabled {
         background: #145DA0;
         color: #fff;
         }
         .top-nav button.active {
         background: #145DA0;
         color: #fff;
         }
         .dropdown-menu {
         display: none;
         position: absolute;
         top: 100%;
         right: 0;
         background: #fff;
         border-radius: 8px;
         box-shadow: 0 2px 6px rgba(0,0,0,0.1);
         z-index: 1000;
         min-width: 150px;
         }
         .dropdown-menu button {
         width: 100%;
         text-align: left;
         border-radius: 0;
         padding: 10px 15px;
         font-size: 14px;
         font-weight: normal;
         }
         .dropdown-menu button:hover {
         background: #145DA0;
         color: #fff;
         }
         .main {
         flex: 1;
         padding: 20px;
         display: flex;
         flex-direction: column;
         }
         .card {
         background: #fff;
         border-radius: 12px;
         padding: 15px;
         margin-bottom: 15px;
         box-shadow: 0 2px 6px rgba(0,0,0,0.1);
         text-align: center;
         position: relative;
         min-height: 300px;
         }
         .card h2 {
         font-family: 'Montserrat', sans-serif;
         margin-bottom: 15px;
         padding: 10px;
         }
         .card p {
         padding: 10px;
         }

         .action-buttons {
         display: flex;
         justify-content: center;
         gap: 10px;
         margin-top: 20px;
         align-items: center;
         }
         .action-buttons button {
         background: #fff;
         color: #2E8BC0;
         border: none;
         padding: 8px;
         border-radius: 8px;
         cursor: pointer;
         transition: 0.3s;
         font-size: 14px;
         display: flex;
         align-items: center;
         gap: 5px;
         }

.action-buttons button:hover:enabled:not(#shareBtn):not(#bookmarkBtn) {
  color: red;
}
.action-buttons #shareBtn:active, .action-buttons #shareBtn:focus {
  color: #2E8BC0;
  background: #fff;
}
.bookmark-btn {
  background: #fff;
  color: #2E8BC0;
  border: none;
  padding: 8px;
}
.bookmark-btn.bookmarked {
  background: #145DA0;
  color: #fff;
}
.bookmark-btn:hover:enabled {
  background: #145DA0;
  color: #fff;
}
.bookmark-btn.bookmarked i {
  color: #fff;
}
.action-buttons .bookmark-btn:not(.bookmarked) {
  background: #fff !important;
}
.bookmark-btn:not(.bookmarked) i {
  color: #2E8BC0;
}
.bookmark-btn:not(.bookmarked):active, .bookmark-btn:not(.bookmarked):focus {
  background: #fff;
  color: #2E8BC0;
}
         .action-buttons button:disabled {
         background: #ccc;
         color: #666;
         cursor: not-allowed;
         }
         /* Navigation buttons */
         .nav-buttons {
         display: flex;
         justify-content: center;
         gap: 20px;
         margin-top: 20px;
         }
         .nav-buttons button {
         background: #2E8BC0;
         border: none;
         padding: 15px 40px;
         border-radius: 10px;
         color: #fff;
         font-size: 16px;
         cursor: pointer;
         transition: 0.3s;
         width: 120px;
         text-align: center;
         display: flex;
         align-items: center;
         justify-content: center;
         gap: 5px;
         }
         .nav-buttons button:hover:enabled {
         background: #145DA0;
         }
         .nav-buttons button:disabled {
         background: #ccc;
         color: #666;
         cursor: not-allowed;
         }
         /* Comments Section */
         .comments {
         flex: 1;
         background: #fff;
         border-radius: 12px;
         padding: 15px;
         box-shadow: 0 2px 6px rgba(0,0,0,0.1);
         display: flex;
         flex-direction: column;
         }
         .comments-header {
         display: flex;
         justify-content: space-between;
         align-items: center;
         margin-bottom: 10px;
         }
         .stats {
         font-size: 14px;
         color: #555;
         }
         .stats i {
         color: #666;
         }
         .actions {
         display: flex;
         gap: 10px;
         align-items: center;
         }
         .actions button {
         background: #fff;
         color: #2E8BC0;
         border: none;
         padding: 8px 8px;
         border-radius: 8px;
         cursor: pointer;
         transition: 0.3s;
         font-size: 14px;
         display: flex;
         align-items: center;
         gap: 5px;
         }
         .actions button:hover:enabled {
         background: #145DA0;
         color: #fff;
         }
         .actions button:disabled {
         background: #ccc;
         color: #666;
         cursor: not-allowed;
         }
         .comment-list {
         max-height: 400px;
         overflow-y: auto;
         margin-bottom: 12px;
         }
         .comment {
         margin-bottom: 12px;
         padding: 10px;
         border-bottom: 1px solid #eee;
         }
         .comment strong {
         display: block;
         color: #145DA0;
         }
         .comment-actions {
         display: flex;
         gap: 10px;
         margin-top: 5px;
         }
         .comment-actions button {
         background: #fff;
         color: #2E8BC0;
         border: none;
         padding: 5px 8px;
         border-radius: 8px;
         cursor: pointer;
         transition: 0.3s;
         font-size: 12px;
         display: flex;
         align-items: center;
         gap: 5px;
         }
         .comment-actions button:hover:enabled {
         background: #145DA0;
         color: #fff;
         }
         .comment-actions button:disabled {
         background: #ccc;
         color: #666;
         cursor: not-allowed;
         }
         .action-buttons button i.fa-solid.fa-heart {
         color: #ff0000;
         }
/* Instagram-like like button animation */
.action-buttons #likeBtn.liked-anim i {
  animation: likePulse 0.3s ease-out;
}

@keyframes likePulse {
  0% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.8);
  }
  100% {
    transform: scale(1);
  }
}

/* Respect user motion preferences */
@media (prefers-reduced-motion: reduce) {
  .action-buttons #likeBtn.liked-anim i {
    animation: none;
  }
}
         .liked-phrases-list .remove-btn i.fa-solid.fa-heart {
         color: #ff0000;
         }
         .comment-actions button:disabled i.fa-solid.fa-heart {
         color: #ff0000;
         }
         .reply {
         margin-left: 20px;
         margin-top: 8px;
         padding: 8px;
         border-left: 2px solid #2E8BC0;
         }
         .pagination {
         display: flex;
         justify-content: center;
         gap: 10px;
         margin-top: 10px;
         }
         .pagination button {
         background: #2E8BC0;
         border: none;
         padding: 8px 16px;
         border-radius: 8px;
         color: #fff;
         cursor: pointer;
         transition: 0.3s;
         font-size: 14px;
         }
         .pagination button:disabled {
         background: #ccc;
         color: #666;
         cursor: not-allowed;
         }
         .pagination button:hover:enabled {
         background: #145DA0;
         }
         /* Quiz buttons */
         .quiz-option {
         background: #2E8BC0;
         border: none;
         padding: 12px 20px;
         margin: 10px 0;
         border-radius: 8px;
         color: #fff;
         font-size: 15px;
         width: 100%;
         cursor: pointer;
         transition: 0.3s;
         }
         .quiz-option:hover {
         background: #145DA0;
         }
         /* Quiz Header */
         .quiz-header {
         font-family: 'Montserrat', sans-serif;
         font-size: 20px;
         margin-top: 10px;
         margin-bottom: 10px;
         color: #2E8BC0;
         }
         /* Popup Modal */
         .modal {
         display: none;
         position: fixed;
         top: 0; left: 0;
         width: 100%; height: 100%;
         background: rgba(0,0,0,0.5);
         justify-content: center;
         align-items: center;
         }
         .modal-content {
         background: white;
         padding: 20px;
         border-radius: 10px;
         text-align: center;
         width: 90%;
         max-width: 280px;
         min-height: 200px;
         box-shadow: 0 2px 10px rgba(0,0,0,0.2);
         position: relative;
         display: flex;
         flex-direction: column;
         justify-content: space-between;
         }
         .modal-content.correct-answer .share-icon {
         display: block !important;
         }
         .modal-content.correct-answer .share-text {
         display: block !important;
         }
         .modal-content .banner {
         background: #2E8BC0;
         color: #fff;
         padding: 10px;
         font-family: 'Montserrat', sans-serif;
         font-size: 20px;
         font-weight: 600;
         text-align: center;
         border-top-left-radius: 10px;
         border-top-right-radius: 10px;
         margin: -20px -20px 20px -20px;
         }
         .modal-content p.tick-item {
         text-align: left;
         margin-bottom: 4px;
         padding-left: 15px;
         display: flex;
         align-items: center;
         }
         .modal-content p.tick-item i {
         color: #2E8BC0;
         margin-right: 20px;
         }
         .modal-content .button-row {
         display: flex;
         justify-content: center;
         align-items: center;
         gap: 10px;
         margin-top: 10px;
         }
         .modal-content button {
         background: #2E8BC0;
         border: none;
         padding: 8px 16px;
         border-radius: 8px;
         color: #fff;
         cursor: pointer;
         display: flex;
         align-items: center;
         gap: 5px;
         font-size: 14px;
         }
         .modal-content button:disabled {
         background: #ccc;
         color: #666;
         cursor: not-allowed;
         }
         .modal-content a.share-icon {
         color: #2E8BC0;
         font-size: 16px;
         cursor: pointer;
         transition: 0.3s;
         text-decoration: none;
         position: absolute;
         top: 50px;
         right: 10px;
         display: none;
         }
         .modal-content a.share-icon:hover {
         color: #145DA0;
         }
         .modal-content .share-text {
         position: absolute;
         top: 52px;
         right: 35px;
         font-size: 12px;
         font-style: italic;
         color: #555;
         display: none;
         }
         .modal-content .streak-conditions {
         font-size: 12px;
         font-style: italic;
         color: #555;
         margin-top: 10px;
         text-align: center;
         }
         .medal-bronze {
         color: #cd7f32;
         }
         .medal-silver {
         color: #c0c0c0;
         }
         .medal-gold {
         color: #ffd700;
         }
         .progress-bar {
         width: 100%;
         height: 6px;
         background: #eee;
         margin-top: 10px;
         border-radius: 3px;
         overflow: hidden;
         }
         .progress-fill {
         height: 100%;
         width: 0;
         background: #2E8BC0;
         transition: width 5s linear;
         }
         .modal-content input, .modal-content textarea {
         width: 100%;
         padding: 8px;
         margin-bottom: 8px;
         box-sizing: border-box;
         }
         .modal-content #popupMessage {
         text-align: center;
         }
         .liked-phrases-list {
         max-height: 300px;
         overflow-y: auto;
         margin-bottom: 10px;
         }
         .liked-phrases-list button {
         background: #2E8BC0;
         color: #fff;
         border: none;
         padding: 10px;
         margin: 5px 0;
         border-radius: 8px;
         width: 100%;
         text-align: left;
         cursor: pointer;
         transition: 0.3s;
         font-size: 14px;
         }
         .liked-phrases-list button:hover {
         background: #145DA0;
         }
         .liked-phrases-list .phrase-container {
         display: flex;
         justify-content: space-between;
         align-items: center;
         gap: 10px;
         margin: 5px 0;
         }
         .liked-phrases-list .phrase-btn {
         flex: 1;
         background: #2E8BC0;
         color: #fff;
         border: none;
         padding: 10px;
         border-radius: 8px;
         text-align: left;
         cursor: pointer;
         transition: 0.3s;
         font-size: 14px;
         }
         .liked-phrases-list .phrase-btn:hover {
         background: #145DA0;
         }
         .liked-phrases-list .remove-btn {
         background: #fff;
         color: #2E8BC0;
         border: none;
         padding: 5px;
         border-radius: 8px;
         cursor: pointer;
         transition: 0.3s;
         font-size: 12px;
         display: flex;
         align-items: center;
         width: 24px;
         justify-content: center;
         }
         .liked-phrases-list .remove-btn:hover {
         background: #145DA0;
         color: #fff;
         }
         #cookieConsent a:hover {
         color: #145DA0;
         }
         #cookieConsent button:hover {
         background: #145DA0;
         color: #fff;
         }
         /* Email Notification Modal Specific Styles */
         .modal-content .input-row {
         display: flex;
         justify-content: space-between;
         align-items: center;
         gap: 10px;
         margin-bottom: 5px;
         }
         .modal-content label {
         flex: 1;
         text-align: left;
         font-size: 16px;
         margin: 0;
         }
         .modal-content input[type="checkbox"],
         .modal-content input[type="email"],
         .modal-content select {
         flex: 0 0 auto;
         width: auto;
         margin: 0;
         padding: 5px;
         font-size: 15px;
         }
         .modal-content input[type="email"],
         .modal-content select {
         width: 120px;
         }
         .modal-content p {
         font-size: 16px;
         color: #555;
         text-align: left;
         margin: 5px 0;
         }
      </style>
   </head>
   <body>
      <div id="cookieConsent" style="display:none; position:fixed; bottom:0; left:0; right:0; background:#2E8BC0; color:#fff; padding:10px; text-align:center; z-index:1000;">
         <p>We use cookies to track usage and improve your experience. <a href="https://learntrend.github.io/FlyTie/privacy-policy.html" style="color:#fff; text-decoration:underline;">Learn more</a></p>
         <button onclick="acceptCookies()" style="background:#fff; color:#2E8BC0; border:none; padding:8px 16px; border-radius:8px; cursor:pointer; margin-left:10px;">Accept</button>
         <button onclick="declineCookies()" style="background:#fff; color:#2E8BC0; border:none; padding:8px 16px; border-radius:8px; cursor:pointer; margin-left:10px;">Decline</button>
      </div>
      <!-- Top Nav -->
      <div class="top-nav">
         <div class="left">
            <button id="logoBtn" onclick="showSection('phrase')" aria-label="View Phrases" class="active">
            <img src="images/logo.png" alt="FlyTie Logo" class="app-logo">
            </button>
            <button id="quizBtn" onclick="showSection('quiz')" aria-label="View Quiz"><i class="fa-solid fa-dice"></i></button>
            <button id="infoBtn" onclick="showInfo()" aria-label="View App Info"><i class="fa-solid fa-circle-info"></i></button>
            <button id="dropdownBtn" onclick="toggleDropdown()" aria-label="More Options"><i class="fa-solid fa-caret-down"></i></button>
            <div id="dropdownMenu" class="dropdown-menu">
               <button onclick="showStreakPopup()">My Streak</button>
               <button onclick="showLikedPhrasesPopup()">Liked Phrases</button>
               <button onclick="showBookmarkPopup()">My Bookmark</button>
               <button onclick="showContactPopup()">Contact Us</button>
               <button onclick="showEmailNotificationPopup()">Notify me</button>
            </div>
         </div>
         <button onclick="globalShare()" aria-label="Share FlyTie"><i class="fa-solid fa-arrow-up-from-bracket"></i></button>
      </div>
      <!-- Main Content -->
      <div class="main">
         <!-- Phrase Section -->
         <div id="phraseSection">
            <div class="card">
               <div class="quiz-header" id="phraseHeader" style="display:none;">Phrase of the Day</div>
               <h2 id="phraseText">Loading...</h2>
               <p><strong>Meaning:</strong> <span id="meaningText">Loading...</span></p>
               <p><strong>Usage:</strong> <span id="usageText">Loading...</span></p>
               <div class="action-buttons">
                  <button id="likeBtn" onclick="toggleLikePhrase()" aria-label="Like this phrase"><i class="fa-regular fa-heart"></i></button>
                  <button id="shareBtn" onclick="globalShare()" aria-label="Share this phrase"><i class="fa-solid fa-arrow-up-from-bracket"></i></button>
                  <button id="bookmarkBtn" class="bookmark-btn" onclick="toggleBookmark()" aria-label="Bookmark this phrase"><i class="fa-regular fa-bookmark"></i></button>
               </div>
               <!-- Navigation -->
               <div class="nav-buttons">
                  <button id="prevPhraseBtn" onclick="prevPhrase()" aria-label="Previous Phrase"><i class="fas fa-chevron-left"></i></button>
                  <button id="nextPhraseBtn" onclick="nextPhrase()" aria-label="Next Phrase"><i class="fas fa-chevron-right"></i></button>
               </div>
            </div>
         </div>
         <!-- Quiz Section -->
         <div id="quizSection" style="display:none;">
            <div class="card">
               <div class="quiz-header">Quiz of the Day</div>
               <h2 id="quizTitle">Loading...</h2>
               <div id="quizOptions">
                  <!-- Options loaded dynamically -->
               </div>
            </div>
         </div>
         <!-- Comments Section -->
         <div class="comments">
            <div class="comments-header">
               <div class="stats">
                  <i class="fas fa-comment"></i> <span id="commentCount">0</span>
               </div>
               <div class="actions">
                  <span>Like FlyTie?</span>
                  <button id="commentBtn" aria-label="Add a Comment">Comment</button>
               </div>
            </div>
            <div id="commentList" class="comment-list">
               <!-- Comments loaded dynamically -->
            </div>
            <div class="pagination">
               <button id="prevComments" onclick="prevCommentsPage()" disabled>Previous</button>
               <button id="nextComments" onclick="nextCommentsPage()">Next</button>
            </div>
         </div>
      </div>
      <!-- Modals -->
      <div class="modal" id="popup">
         <div class="modal-content">
            <div class="banner" id="quizBanner"></div>
            <span class="share-text">Share with your friends</span>
            <a id="shareBtn" class="share-icon" onclick="shareResult()" aria-label="Share Quiz Result"><i class="fa-solid fa-arrow-up-from-bracket"></i></a>
            <p id="popupMessage"></p>
            <div class="progress-bar" id="progressBar" style="display:none;">
               <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="button-row" id="popupButtonRow">
               <button id="okBtn" onclick="closePopup()">OK</button>
            </div>
         </div>
      </div>
      <!-- Info Modal -->
      <div class="modal" id="infoPopup" onclick="event.stopPropagation()">
         <div class="modal-content">
            <div class="banner">About FlyTie</div>
            <p class="tick-item"><i class="fa-solid fa-quote-left"></i> Learn new professional phrases daily</p>
            <p class="tick-item"><i class="fa-solid fa-brain"></i> Test your knowledge with fun quizzes</p>
            <p class="tick-item"><i class="fa-solid fa-heart"></i> Like your favorite phrases</p>
            <p class="tick-item"><i class="fa-solid fa-bookmark"></i> Bookmark your phrases to keep track of your progress </p>
            <p class="tick-item"><i class="fa-solid fa-user-group"></i> Share your quiz results with your friends</p>
            <p class="tick-item"><i class="fa-solid fa-comment"></i> Add comments to connect with others</p>
            <p class="tick-item"><i class="fa-solid fa-medal"></i> Check & Share your streak </p>
            <p class="tick-item"><i class="fa-solid fa-bell"></i> Get updated on the new phrases daily </p>
            <div class="button-row">
               <button onclick="closeInfoPopup()">OK</button>
            </div>
         </div>
      </div>
      <!-- Comment Modal -->
      <div class="modal" id="commentPopup">
         <div class="modal-content">
            <div class="banner">Add a Comment</div>
            <input id="username" type="text" placeholder="Your name">
            <textarea id="commentText" placeholder="Add a comment..."></textarea>
            <div class="button-row">
               <button onclick="submitComment()">Submit</button>
               <button onclick="closeCommentPopup()">Close</button>
            </div>
         </div>
      </div>
      <!-- Reply Modal -->
      <div class="modal" id="replyPopup">
         <div class="modal-content">
            <div class="banner">Reply to Comment</div>
            <input id="replyUsername" type="text" placeholder="Your name">
            <textarea id="replyText" placeholder="Add a reply..."></textarea>
            <div class="button-row">
               <button onclick="submitReply()">Submit</button>
               <button onclick="closeReplyPopup()">Close</button>
            </div>
         </div>
      </div>
      <!-- Streak Modal -->
      <div class="modal" id="streakPopup">
         <div class="modal-content">
            <div class="banner">Your Streak</div>
            <p id="streakMessage">Your Streak: 0 days 🔥</p>
            <a id="streakShareBtn" class="share-icon" onclick="shareStreak()" aria-label="Share Streak"></a>
            <span class="streak-conditions">Week 1 - Bronze Medal, Week 2 - Silver Medal, Week 3 onwards - Gold Medal</span>
            <div class="button-row">
               <button onclick="shareStreak()">Share</button>
               <button onclick="closeStreakPopup()">OK</button>
            </div>
         </div>
      </div>
      <!-- Liked Phrases Modal -->
      <div class="modal" id="likedPhrasesPopup">
         <div class="modal-content">
            <div class="banner">Liked Phrases</div>
            <div id="likedPhrasesList" class="liked-phrases-list"></div>
            <div class="button-row">
               <button onclick="closeLikedPhrasesPopup()">Close</button>
            </div>
         </div>
      </div>
      <!-- Bookmark Modal -->
      <div class="modal" id="bookmarkPopup">
         <div class="modal-content">
            <div class="banner">Bookmarked Phrase</div>
            <p id="bookmarkMessage">No phrase bookmarked.</p>
            <div id="bookmarkNav" class="button-row" style="display:none;">
               <button onclick="goToBookmark()">Go to Phrase</button>
            </div>
            <div class="button-row">
               <button onclick="closeBookmarkPopup()">Close</button>
            </div>
         </div>
      </div>
      <!-- Contact Us Modal -->
      <div class="modal" id="contactPopup">
         <div class="modal-content">
            <div class="banner">Contact Us</div>
            <p>Have feedback, questions, or ran into an issue? We'd love to hear from you! Reach out to share your thoughts or get help.</p>
            <div class="button-row">
               <a href="mailto:vaada2023@gmail.com" style="text-decoration:none;"><button>Email Us</button></a>
               <button onclick="closeContactPopup()">Close</button>
            </div>
         </div>
      </div>
      <!-- Email Notification Modal -->
      <div class="modal" id="emailNotificationPopup">
         <div class="modal-content">
            <div class="banner">Daily Email Reminders</div>
            <p>Receive a daily email for new phrases!</p>
            <p></p>
            <div class="input-row">
               <label for="enableEmailNotifications">Enable Email Notifications:</label>
               <input type="checkbox" id="enableEmailNotifications">
            </div>
            <div class="input-row">
               <label for="email">Email Address:</label>
               <input type="email" id="email" placeholder="your@email.com">
            </div>
            <div class="input-row">
               <label for="notificationTime">Daily Notification Time (24h):</label>
               <select id="notificationTime">
                  <option value="00:00">00:00</option>
                  <option value="00:15">00:15</option>
                  <option value="00:30">00:30</option>
                  <option value="00:45">00:45</option>
                  <option value="01:00">01:00</option>
                  <option value="01:15">01:15</option>
                  <option value="01:30">01:30</option>
                  <option value="01:45">01:45</option>
                  <option value="02:00">02:00</option>
                  <option value="02:15">02:15</option>
                  <option value="02:30">02:30</option>
                  <option value="02:45">02:45</option>
                  <option value="03:00">03:00</option>
                  <option value="03:15">03:15</option>
                  <option value="03:30">03:30</option>
                  <option value="03:45">03:45</option>
                  <option value="04:00">04:00</option>
                  <option value="04:15">04:15</option>
                  <option value="04:30">04:30</option>
                  <option value="04:45">04:45</option>
                  <option value="05:00">05:00</option>
                  <option value="05:15">05:15</option>
                  <option value="05:30">05:30</option>
                  <option value="05:45">05:45</option>
                  <option value="06:00">06:00</option>
                  <option value="06:15">06:15</option>
                  <option value="06:30">06:30</option>
                  <option value="06:45">06:45</option>
                  <option value="07:00">07:00</option>
                  <option value="07:15">07:15</option>
                  <option value="07:30">07:30</option>
                  <option value="07:45">07:45</option>
                  <option value="08:00">08:00</option>
                  <option value="08:15">08:15</option>
                  <option value="08:30">08:30</option>
                  <option value="08:45">08:45</option>
                  <option value="09:00">09:00</option>
                  <option value="09:15">09:15</option>
                  <option value="09:30">09:30</option>
                  <option value="09:45">09:45</option>
                  <option value="10:00">10:00</option>
                  <option value="10:15">10:15</option>
                  <option value="10:30">10:30</option>
                  <option value="10:45">10:45</option>
                  <option value="11:00">11:00</option>
                  <option value="11:15">11:15</option>
                  <option value="11:30">11:30</option>
                  <option value="11:45">11:45</option>
                  <option value="12:00">12:00</option>
                  <option value="12:15">12:15</option>
                  <option value="12:30">12:30</option>
                  <option value="12:45">12:45</option>
                  <option value="13:00">13:00</option>
                  <option value="13:15">13:15</option>
                  <option value="13:30">13:30</option>
                  <option value="13:45">13:45</option>
                  <option value="14:00">14:00</option>
                  <option value="14:15">14:15</option>
                  <option value="14:30">14:30</option>
                  <option value="14:45">14:45</option>
                  <option value="15:00">15:00</option>
                  <option value="15:15">15:15</option>
                  <option value="15:30">15:30</option>
                  <option value="15:45">15:45</option>
                  <option value="16:00">16:00</option>
                  <option value="16:15">16:15</option>
                  <option value="16:30">16:30</option>
                  <option value="16:45">16:45</option>
                  <option value="17:00">17:00</option>
                  <option value="17:15">17:15</option>
                  <option value="17:30">17:30</option>
                  <option value="17:45">17:45</option>
                  <option value="18:00">18:00</option>
                  <option value="18:15">18:15</option>
                  <option value="18:30">18:30</option>
                  <option value="18:45">18:45</option>
                  <option value="19:00">19:00</option>
                  <option value="19:15">19:15</option>
                  <option value="19:30">19:30</option>
                  <option value="19:45">19:45</option>
                  <option value="20:00">20:00</option>
                  <option value="20:15">20:15</option>
                  <option value="20:30">20:30</option>
                  <option value="20:45">20:45</option>
                  <option value="21:00">21:00</option>
                  <option value="21:15">21:15</option>
                  <option value="21:30">21:30</option>
                  <option value="21:45">21:45</option>
                  <option value="22:00">22:00</option>
                  <option value="22:15">22:15</option>
                  <option value="22:30">22:30</option>
                  <option value="22:45">22:45</option>
                  <option value="23:00">23:00</option>
                  <option value="23:15">23:15</option>
                  <option value="23:30">23:30</option>
                  <option value="23:45">23:45</option>
               </select>
            </div>
            <p>Your email is used only for reminders and stored securely.</p>
            <div class="button-row">
               <button onclick="saveEmailNotificationSettings()">Save</button>
               <button onclick="closeEmailNotificationPopup()">Cancel</button>
            </div>
         </div>
      </div>
      <script>
         let quizStartTime = null;
         let phrases = [];
         let quizzes = [];
         let currentIndex = 0;
         let currentCommentId = null;
         let currentCommentPage = 0;
         const commentsPerPage = 10;
         const PHRASES_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSx3wQD_d33uZsOTPlmRddf01gml1iuRiAMLyvGVk9U-Kv2-F5zIGUuSBuOBgu2O36ntNUD4KlaYhoZ/pub?output=csv";
         const QUIZ_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSx3wQD_d33uZsOTPlmRddf01gml1iuRiAMLyvGVk9U-Kv2-F5zIGUuSBuOBgu2O36ntNUD4KlaYhoZ/pub?gid=102179282&single=true&output=csv";
         const COMMENT_URL = "https://script.google.com/macros/s/AKfycbxl7f418cVMQujizOsmtfyJSmhEvDMVGgu0CZqP5mUkiliGbC8N95dg6LNnXqrXeFkSUA/exec";
         function acceptCookies() {
           localStorage.setItem('cookieConsent', 'accepted');
           document.getElementById('cookieConsent').style.display = 'none';
           gtag('consent', 'update', {
             'analytics_storage': 'granted'
           });
         }
         function declineCookies() {
           localStorage.setItem('cookieConsent', 'denied');
           document.getElementById('cookieConsent').style.display = 'none';
           gtag('consent', 'update', {
             'analytics_storage': 'denied'
           });
         }
         if (!localStorage.getItem('cookieConsent')) {
           document.getElementById('cookieConsent').style.display = 'block';
         } else if (localStorage.getItem('cookieConsent') === 'accepted') {
           gtag('consent', 'update', {
             'analytics_storage': 'granted'
           });
         }
         async function fetchWithRetry(url, options = {}, retries = 3, delay = 3000) {
           for (let i = 0; i < retries; i++) {
             try {
               const controller = new AbortController();
               const timeoutId = setTimeout(() => controller.abort(), 5000);
               const res = await fetch(url, { ...options, signal: controller.signal });
               clearTimeout(timeoutId);
               if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
               const contentType = res.headers.get('content-type') || '';
               if (contentType.includes('application/json')) {
                 return await res.json();
               } else if (contentType.includes('text/csv') || contentType.includes('text/plain')) {
                 return await res.text();
               } else {
                 throw new Error('Unexpected content type: ' + contentType);
               }
             } catch (e) {
               if (i === retries - 1) throw e;
               console.warn(`Fetch attempt ${i + 1} failed for ${url}: ${e.message}. Retrying...`);
               await new Promise(resolve => setTimeout(resolve, delay));
             }
           }
         }
         function updateStreak() {
           const today = new Date().toDateString();
           const lastVisit = localStorage.getItem('lastVisit');
           let streak = parseInt(localStorage.getItem('streak')) || 0;
           if (!lastVisit) {
             streak = 1;
           } else {
             const lastVisitDate = new Date(lastVisit);
             const yesterday = new Date();
             yesterday.setDate(new Date().getDate() - 1);
             if (lastVisit === today) {
               streak = streak;
             } else if (lastVisitDate.toDateString() === yesterday.toDateString()) {
               streak += 1;
             } else {
               streak = 1;
             }
           }
           localStorage.setItem('streak', streak);
           localStorage.setItem('lastVisit', today);
           return streak;
         }
         function toggleDropdown() {
           const dropdownMenu = document.getElementById('dropdownMenu');
           const isOpen = dropdownMenu.style.display === 'block';
           dropdownMenu.style.display = isOpen ? 'none' : 'block';
           if (!isOpen) {
             document.addEventListener('click', closeDropdownOnOutsideClick);
           } else {
             document.removeEventListener('click', closeDropdownOnOutsideClick);
           }
         }
         function closeDropdownOnOutsideClick(event) {
           const dropdownMenu = document.getElementById('dropdownMenu');
           const dropdownBtn = document.getElementById('dropdownBtn');
           if (!dropdownMenu.contains(event.target) && !dropdownBtn.contains(event.target)) {
             dropdownMenu.style.display = 'none';
             document.removeEventListener('click', closeDropdownOnOutsideClick);
           }
         }
         function showContactPopup() {
           toggleDropdown();
           document.getElementById('contactPopup').style.display = 'flex';
           document.body.classList.add('no-scroll');
         }
         function closeContactPopup() {
           document.getElementById('contactPopup').style.display = 'none';
           document.body.classList.remove('no-scroll');
         }
         function showEmailNotificationPopup() {
           toggleDropdown();
           document.getElementById('emailNotificationPopup').style.display = 'flex';
           document.body.classList.add('no-scroll');
           const settings = JSON.parse(localStorage.getItem('emailNotificationSettings') || '{}');
           document.getElementById('enableEmailNotifications').checked = settings.enabled || false;
           document.getElementById('email').value = settings.email || '';
           document.getElementById('notificationTime').value = settings.time || '09:00';
         }
         function closeEmailNotificationPopup() {
           document.getElementById('emailNotificationPopup').style.display = 'none';
           document.body.classList.remove('no-scroll');
         }
         async function saveEmailNotificationSettings() {
           const enabled = document.getElementById('enableEmailNotifications').checked;
           const email = document.getElementById('email').value;
           const time = document.getElementById('notificationTime').value;
           if (enabled && !email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
             alert('Please enter a valid email address.');
             return;
           }
           const settings = { enabled, email, time };
           localStorage.setItem('emailNotificationSettings', JSON.stringify(settings));
           const userId = generateUserId();
           try {
             const response = await fetchWithRetry(`${COMMENT_URL}?action=saveEmail`, {
               method: 'POST',
               body: new URLSearchParams({
                 userId,
                 email,
                 time,
                 enabled: enabled.toString()
               })
             });
             if (response.status !== 'success') {
               throw new Error(response.message || 'Failed to save email settings');
             }
             if (localStorage.getItem('cookieConsent') === 'accepted') {
               gtag('event', 'notification_subscription', {
                 'type': 'email',
                 'event_category': 'engagement',
                 'event_label': enabled ? 'Email Notification Enabled' : 'Email Notification Disabled'
               });
             }
             alert('Email notifications saved! You\'ll receive reminders as scheduled.');
             closeEmailNotificationPopup();
           } catch (e) {
             console.error('Error saving notification settings:', e);
             alert('Failed to save settings: ' + e.message);
           }
         }
         function generateUserId() {
           let userId = localStorage.getItem('userId');
           if (!userId) {
             userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
             localStorage.setItem('userId', userId);
           }
           return userId;
         }
         function showStreakPopup() {
           toggleDropdown();
           const streak = parseInt(localStorage.getItem('streak')) || 0;
           const streakMessage = document.getElementById('streakMessage');
           const streakConditions = document.querySelector('#streakPopup .streak-conditions');
           const streakShareBtn = document.getElementById('streakShareBtn');
           if (streak > 0) {
             streakMessage.innerHTML = `Your Streak: ${streak} day${streak !== 1 ? 's' : ''}!<br>You earned a badge <i class="fa-solid fa-medal"></i>`;
             const medalIcon = streakMessage.querySelector('i');
             medalIcon.classList.remove('medal-bronze', 'medal-silver', 'medal-gold');
             if (streak >= 1 && streak <= 7) {
               medalIcon.classList.add('medal-bronze');
             } else if (streak >= 8 && streak <= 14) {
               medalIcon.classList.add('medal-silver');
             } else if (streak >= 15) {
               medalIcon.classList.add('medal-gold');
             }
             streakConditions.style.display = 'block';
             streakShareBtn.style.display = 'inline-block';
           } else {
             streakMessage.innerHTML = `Your Streak: 0 days 🔥`;
             streakConditions.style.display = 'none';
             streakShareBtn.style.display = 'none';
           }
           document.getElementById('streakPopup').style.display = 'flex';
           document.body.classList.add('no-scroll');
         }
         function closeStreakPopup() {
           document.getElementById('streakPopup').style.display = 'none';
           document.body.classList.remove('no-scroll');
         }
         function shareStreak() {
           const streak = parseInt(localStorage.getItem('streak')) || 0;
           if (navigator.share) {
             navigator.share({
               title: 'FlyTie - My Streak',
               text: `I've kept a ${streak} day streak on FlyTie! 🔥`,
               url: window.location.href
             }).then(() => {
               if (localStorage.getItem('cookieConsent') === 'accepted') {
                 gtag('event', 'share_streak', {
                   'streak_length': streak,
                   'event_category': 'engagement',
                   'event_label': 'Streak Shared'
                 });
               }
             }).catch(err => {
               if (err.name === 'AbortError' || err.name === 'NotAllowedError' || err.message.toLowerCase().includes('cancel')) {
                 return;
               }
               console.error('Error sharing streak:', err);
               alert('Error sharing streak: An unexpected error occurred. Please try again.');
             });
           } else {
             alert("Sharing not supported on this browser.");
           }
         }
         function showLikedPhrasesPopup() {
           toggleDropdown();
           const likedPhrases = JSON.parse(localStorage.getItem('likedPhrases') || '[]');
           const likedPhrasesList = document.getElementById('likedPhrasesList');
           likedPhrasesList.innerHTML = '';
           if (likedPhrases.length === 0) {
             likedPhrasesList.innerHTML = '<p>No liked phrases.</p>';
           } else {
             likedPhrases.forEach((phrase, index) => {
               const container = document.createElement('div');
               container.className = 'phrase-container';
               
               const btn = document.createElement('button');
               btn.className = 'phrase-btn';
               btn.textContent = phrase;
               btn.onclick = () => {
                 const phraseIndex = phrases.findIndex(p => p.phrase === phrase);
                 if (phraseIndex !== -1) {
                   currentIndex = phraseIndex;
                   closeLikedPhrasesPopup();
                   showSection('phrase');
                   showPhrase();
                 }
               };
               
               const removeBtn = document.createElement('button');
               removeBtn.className = 'remove-btn';
               removeBtn.innerHTML = '<i class="fas fa-times"></i>';
               removeBtn.onclick = () => removeLikedPhrase(phrase);
               
               container.appendChild(btn);
               container.appendChild(removeBtn);
               likedPhrasesList.appendChild(container);
             });
           }
           document.getElementById('likedPhrasesPopup').style.display = 'flex';
           document.body.classList.add('no-scroll');
         }
async function removeLikedPhrase(phrase) {
  let likedPhrases = JSON.parse(localStorage.getItem('likedPhrases') || '[]');
  likedPhrases = likedPhrases.filter(p => p !== phrase);
  localStorage.setItem('likedPhrases', JSON.stringify(likedPhrases));
  
  // Update the UI instantly
  const likedPhrasesList = document.getElementById('likedPhrasesList');
  const phraseContainer = Array.from(likedPhrasesList.getElementsByClassName('phrase-container')).find(
    container => container.querySelector('.phrase-btn').textContent === phrase
  );
  if (phraseContainer) {
    phraseContainer.remove();
  }
  // Show "No liked phrases" if the list is empty
  if (likedPhrases.length === 0) {
    likedPhrasesList.innerHTML = '<p>No liked phrases.</p>';
  }
  
  // Remove focus from any button
  document.activeElement.blur();
  
  // Update the like button in the phrase section if viewing the same phrase
  const likeBtn = document.getElementById('likeBtn');
  if (phrases[currentIndex]?.phrase === phrase) {
    likeBtn.innerHTML = '<i class="fa-regular fa-heart"></i>';
  }
  
  try {
    let data = await fetchWithRetry(`${COMMENT_URL}?action=removeLike&phrase=${encodeURIComponent(phrase)}`, {
      method: 'POST'
    });
    if (!data || data.status !== 'success') {
      throw new Error(data?.message || 'Invalid response from server');
    }
    if (localStorage.getItem('cookieConsent') === 'accepted') {
      gtag('event', 'phrase_unliked', {
        'phrase': phrase,
        'event_category': 'engagement',
        'event_label': 'Phrase Unliked'
      });
    }
  } catch (e) {
    console.error('Error removing like:', e);
    // Revert local change on error
    likedPhrases.push(phrase);
    localStorage.setItem('likedPhrases', JSON.stringify(likedPhrases));
    // Re-add the phrase to the UI
    const container = document.createElement('div');
    container.className = 'phrase-container';
    const btn = document.createElement('button');
    btn.className = 'phrase-btn';
    btn.textContent = phrase;
    btn.onclick = () => {
      const phraseIndex = phrases.findIndex(p => p.phrase === phrase);
      if (phraseIndex !== -1) {
        currentIndex = phraseIndex;
        closeLikedPhrasesPopup();
        showSection('phrase');
        showPhrase();
      }
    };
    const removeBtn = document.createElement('button');
    removeBtn.className = 'remove-btn';
    removeBtn.innerHTML = '<i class="fas fa-times"></i>';
    removeBtn.onclick = () => removeLikedPhrase(phrase);
    container.appendChild(btn);
    container.appendChild(removeBtn);
    likedPhrasesList.innerHTML = ''; // Clear "No liked phrases" message
    likedPhrasesList.appendChild(container);
    // Update like button on error
    if (phrases[currentIndex]?.phrase === phrase) {
      likeBtn.innerHTML = '<i class="fa-solid fa-heart"></i>';
    }
    alert('Failed to unlike phrase: ' + e.message);
  }
}
         function closeLikedPhrasesPopup() {
           document.getElementById('likedPhrasesPopup').style.display = 'none';
           document.body.classList.remove('no-scroll');
         }
         function toggleBookmark() {
           const bookmarkBtn = document.getElementById('bookmarkBtn');
           const currentPhrase = phrases[currentIndex]?.phrase;
           const bookmarkedPhrase = localStorage.getItem('bookmarkedPhrase');
           
           if (bookmarkedPhrase === currentPhrase) {
             localStorage.removeItem('bookmarkedPhrase');
             bookmarkBtn.classList.remove('bookmarked');
             bookmarkBtn.innerHTML = '<i class="fa-regular fa-bookmark"></i>';
           } else {
             localStorage.setItem('bookmarkedPhrase', currentPhrase);
             bookmarkBtn.classList.add('bookmarked');
             bookmarkBtn.innerHTML = '<i class="fa-solid fa-bookmark"></i>';
           }
         }
         function showBookmarkPopup() {
           toggleDropdown();
           const bookmarkedPhrase = localStorage.getItem('bookmarkedPhrase');
           const bookmarkMessage = document.getElementById('bookmarkMessage');
           const bookmarkNav = document.getElementById('bookmarkNav');
           
           if (bookmarkedPhrase && phrases.some(p => p.phrase === bookmarkedPhrase)) {
             bookmarkMessage.textContent = `"${bookmarkedPhrase}"`;
             bookmarkNav.style.display = 'flex';
           } else {
             bookmarkMessage.textContent = 'No phrase bookmarked.';
             bookmarkNav.style.display = 'none';
           }
           document.getElementById('bookmarkPopup').style.display = 'flex';
           document.body.classList.add('no-scroll');
         }
         function updateBookmarkButton() {
           const bookmarkBtn = document.getElementById('bookmarkBtn');
           const currentPhrase = phrases[currentIndex]?.phrase;
           const bookmarkedPhrase = localStorage.getItem('bookmarkedPhrase');
           
           if (bookmarkedPhrase === currentPhrase) {
             bookmarkBtn.classList.add('bookmarked');
             bookmarkBtn.innerHTML = '<i class="fa-solid fa-bookmark"></i>';
           } else {
             bookmarkBtn.classList.remove('bookmarked');
             bookmarkBtn.innerHTML = '<i class="fa-regular fa-bookmark"></i>';
           }
         }
         function goToBookmark() {
           const bookmarkedPhrase = localStorage.getItem('bookmarkedPhrase');
           if (bookmarkedPhrase) {
             const phraseIndex = phrases.findIndex(p => p.phrase === bookmarkedPhrase);
             if (phraseIndex !== -1) {
               currentIndex = phraseIndex;
               closeBookmarkPopup();
               showSection('phrase');
               showPhrase();
             }
           }
         }
         function closeBookmarkPopup() {
           document.getElementById('bookmarkPopup').style.display = 'none';
           document.body.classList.remove('no-scroll');
         }
         function parseCSVLine(line) {
           let parts = [];
           let current = '';
           let inQuote = false;
           for (let i = 0; i < line.length; i++) {
             let char = line[i];
             if (char === '"') {
               if (inQuote && line[i + 1] === '"') {
                 current += '"';
                 i++; // Skip the next quote
               } else {
                 inQuote = !inQuote;
               }
             } else if (char === ',' && !inQuote) {
               parts.push(current.trim());
               current = '';
             } else {
               current += char;
             }
           }
           parts.push(current.trim());
           while (parts.length < 5) {
             parts.push('');
           }
           return parts;
         }
         async function loadPhrases() {
           try {
             let res = await fetchWithRetry(PHRASES_CSV_URL, { cache: 'no-store' });
             let text = res;
             let lines = text.split(/\r?\n/);
             phrases = [];
             if (lines.length > 1) {
               for (let i = 1; i < lines.length; i++) {
                 if (lines[i].trim() === '') continue;
                 let parts = parseCSVLine(lines[i]);
                 if (parts.length >= 3) {
                   phrases.push({
                     phrase: parts[0],
                     meaning: parts[1],
                     usage: parts[2]
                   });
                 }
               }
             }
             showPhrase();
             updateBookmarkButton();
           } catch (e) {
             console.error('Error loading phrases:', e);
             document.getElementById("phraseText").textContent = "Error loading phrases.";
           }
         }
         async function loadQuizzes() {
           try {
             let res = await fetchWithRetry(QUIZ_CSV_URL, { cache: 'no-store' });
             let text = res;
             let lines = text.split(/\r?\n/);
             quizzes = [];
             const maxRows = 50;
             if (lines.length > 1) {
               for (let i = 1; i < lines.length && i <= maxRows; i++) {
                 if (lines[i].trim() === '') continue;
                 let parts = parseCSVLine(lines[i]);
                 if (parts.length >= 5 && parts[0] && parts[1] && parts[2] && parts[3] && parts[4]) {
                   quizzes.push({
                     question: parts[0],
                     option1: parts[1],
                     option2: parts[2],
                     option3: parts[3],
                     answer: parts[4]
                   });
                 }
               }
             }
             updateQuiz();
           } catch (e) {
             console.error('Error loading quizzes:', e);
             document.getElementById('quizTitle').textContent = 'Unable to load quiz. Please try again later.';
           }
         }
         async function loadComments(page = 0) {
           try {
             let data = await fetchWithRetry(`${COMMENT_URL}?action=getComments`);
             if (!data || !data.status || data.status !== 'success' || !Array.isArray(data.comments)) {
               throw new Error(data?.message || 'Invalid comment data');
             }
             let commentList = document.getElementById('commentList');
             commentList.innerHTML = '';
             let start = page * commentsPerPage;
             let end = start + commentsPerPage;
             let comments = data.comments.slice(start, end);
             const userId = generateUserId();
             const likedComments = JSON.parse(localStorage.getItem('likedComments') || '[]');
             if (comments.length === 0 && page === 0) {
               commentList.innerHTML = '<p>No comments available.</p>';
             } else {
               comments.forEach(c => {
                 let newComment = document.createElement('div');
                 newComment.className = 'comment';
                 newComment.dataset.commentId = c.id;
                 const isCommentLiked = likedComments.includes(c.id);
                 let commentHTML = `
                   <strong>${c.username || 'Anonymous'}:</strong> ${c.comment || ''}
                   <div class="comment-actions">
                     <button onclick="showReplyPopup('${c.id}')" aria-label="Reply to this comment"><i class="fas fa-reply"></i> Reply</button>
                     <button onclick="likeComment('${c.id}', false)" aria-label="Like this comment" ${isCommentLiked ? 'disabled' : ''}><i class="${isCommentLiked ? 'fa-solid fa-heart' : 'fa-regular fa-heart'}"></i> Like (<span class="like-count">${c.likes || 0}</span>)</button>
                   </div>
                 `;
                 if (c.replies && Array.isArray(c.replies)) {
                   c.replies.forEach(r => {
                     const isReplyLiked = likedComments.includes(r.id);
                     commentHTML += `
                       <div class="reply" data-comment-id="${r.id}">
                         ${r.username ? `<strong>${r.username}:</strong> ` : ''}${r.reply || ''}
                         <div class="comment-actions">
                           <button onclick="showReplyPopup('${c.id}')" aria-label="Reply to this comment"><i class="fas fa-reply"></i> Reply</button>
                           <button onclick="likeComment('${r.id}', true)" aria-label="Like this reply" ${isReplyLiked ? 'disabled' : ''}><i class="${isReplyLiked ? 'fa-solid fa-heart' : 'fa-regular fa-heart'}"></i> Like (<span class="like-count">${r.likes || 0}</span>)</button>
                         </div>
                       </div>
                     `;
                   });
                 }
                 newComment.innerHTML = commentHTML;
                 commentList.appendChild(newComment);
               });
             }
             document.getElementById('commentCount').textContent = data.comments.length || 0;
             document.getElementById('prevComments').disabled = page === 0;
             document.getElementById('nextComments').disabled = end >= (data.comments.length || 0);
           } catch (e) {
             console.error('Error loading comments:', e);
             document.getElementById('commentList').innerHTML = '<p>Comments unavailable. Please try again later.</p>';
             document.getElementById('commentCount').textContent = '0';
             document.getElementById('prevComments').disabled = true;
             document.getElementById('nextComments').disabled = true;
             if (e.name !== 'AbortError') {
               console.warn('Retrying comment load...');
               setTimeout(() => loadComments(page), 5000);
             }
           }
         }
         function prevCommentsPage() {
           if (currentCommentPage > 0) {
             currentCommentPage--;
             loadComments(currentCommentPage);
           }
         }
         function nextCommentsPage() {
           currentCommentPage++;
           loadComments(currentCommentPage);
         }
         function showPhrase() {
           if (phrases.length > 0) {
             let p = phrases[currentIndex];
             document.getElementById("phraseText").textContent = `"${p.phrase}"`;
             document.getElementById("meaningText").textContent = p.meaning;
             document.getElementById("usageText").textContent = p.usage;
             const likedPhrases = JSON.parse(localStorage.getItem('likedPhrases') || '[]');
             const isLiked = likedPhrases.includes(p.phrase);
             document.getElementById('likeBtn').innerHTML = `<i class="${isLiked ? 'fa-solid fa-heart' : 'fa-regular fa-heart'}"></i>`;
             document.getElementById('phraseHeader').style.display = currentIndex === 0 ? 'block' : 'none';
             updateBookmarkButton();
             // Disable navigation buttons based on current index
             document.getElementById('prevPhraseBtn').disabled = currentIndex === 0;
             document.getElementById('nextPhraseBtn').disabled = currentIndex === phrases.length - 1;
           }
         }
         function prevPhrase() {
           if (currentIndex > 0) {
             currentIndex--;
             showPhrase();
             updateQuiz();
           }
         }
         function nextPhrase() {
           if (currentIndex < phrases.length - 1) {
             currentIndex++;
             showPhrase();
             updateQuiz();
           }
         }
         function showSection(section) {
           // Only allow section change if no modal is open
           if (document.querySelector('.modal[style*="display: flex"]')) return;
           document.getElementById('phraseSection').style.display = (section === 'phrase') ? 'block' : 'none';
           document.getElementById('quizSection').style.display = (section === 'quiz') ? 'block' : 'none';
           if (section === 'quiz') {
             quizStartTime = new Date();
             if (!quizzes.length) {
               loadQuizzes();
             } else {
               updateQuiz();
             }
           }
           document.getElementById('logoBtn').disabled = (section === 'phrase');
           document.getElementById('logoBtn').classList.toggle('active', section === 'phrase');
           document.getElementById('quizBtn').disabled = (section === 'quiz');
           document.getElementById('quizBtn').classList.toggle('active', section === 'quiz');
           document.getElementById('infoBtn').disabled = false;
           document.getElementById('infoBtn').classList.remove('active');
         }
         function showInfo() {
           document.getElementById('infoPopup').style.display = 'flex';
           document.body.classList.add('no-scroll');
           document.getElementById('infoBtn').disabled = true;
           document.getElementById('infoBtn').classList.add('active');
         }
         function closeInfoPopup() {
           document.getElementById('infoPopup').style.display = 'none';
           document.body.classList.remove('no-scroll');
           document.getElementById('infoBtn').disabled = false;
           // Only remove active class if not in phrase or quiz section
           if (document.getElementById('phraseSection').style.display === 'block' ||
               document.getElementById('quizSection').style.display === 'block') {
             document.getElementById('infoBtn').classList.remove('active');
           }
         }
         let lastQuizIndex = -1;
         let currentOptions = []; // Store current quiz options order
         function updateQuiz() {
           if (quizzes.length === 0 || phrases.length === 0) {
             document.getElementById('quizTitle').textContent = 'No quizzes available.';
             return;
           }
           let p = phrases[currentIndex];
           let quizIndex = lastQuizIndex;
           if (quizIndex === -1 || !quizzes[quizIndex]?.question.toLowerCase().includes(p.phrase.toLowerCase())) {
             quizIndex = quizzes.findIndex(q => q.question.toLowerCase().includes(p.phrase.toLowerCase()));
             if (quizIndex === -1) {
               quizIndex = Math.floor(Math.random() * quizzes.length);
             }
             lastQuizIndex = quizIndex;
             // Shuffle options only when selecting a new quiz
             let quiz = quizzes[quizIndex];
             currentOptions = [quiz.option1, quiz.option2, quiz.option3];
             currentOptions = currentOptions.sort(() => Math.random() - 0.5);
           }
           let quiz = quizzes[quizIndex];
           if (!quiz || !quiz.question || !quiz.option1 || !quiz.option2 || !quiz.option3 || !quiz.answer) {
             document.getElementById('quizTitle').textContent = 'Invalid quiz data.';
             localStorage.removeItem('cachedQuizzes');
             localStorage.removeItem('quizCacheTime');
             loadQuizzes();
             return;
           }
           document.getElementById('quizTitle').innerText = quiz.question;
           let quizOptions = document.getElementById('quizOptions');
           const fragment = document.createDocumentFragment();
           currentOptions.forEach(opt => {
             if (!opt) return;
             let isCorrect = opt === quiz.answer;
             let btn = document.createElement('button');
             btn.className = 'quiz-option';
             btn.textContent = opt;
             btn.onclick = () => checkAnswer(isCorrect);
             fragment.appendChild(btn);
           });
           quizOptions.innerHTML = '';
           quizOptions.appendChild(fragment);
         }
         function checkAnswer(isCorrect) {
           const popup = document.getElementById("popup");
           const message = document.getElementById("popupMessage");
           const quizBanner = document.getElementById("quizBanner");
           const shareBtn = document.getElementById("shareBtn");
           const shareText = document.querySelector(".modal-content .share-text");
           const popupButtonRow = document.getElementById("popupButtonRow");
           const progressBar = document.getElementById("progressBar");
           const progressFill = document.getElementById("progressFill");
           const modalContent = document.querySelector(".modal-content");
           if (isCorrect) {
             let endTime = new Date();
             let timeTaken = quizStartTime ? ((endTime - quizStartTime) / 1000).toFixed(2) : 0;
             quizBanner.textContent = "Correct Answer";
             message.innerHTML = `Wohoo 🎉<br>You answered in ${timeTaken} seconds!!`;
             modalContent.classList.add("correct-answer");
             shareBtn.dataset.time = timeTaken;
             popupButtonRow.innerHTML = '<button id="okBtn" onclick="closePopup()">OK</button>';
             progressBar.style.display = "none";
             if (localStorage.getItem('cookieConsent') === 'accepted') {
               gtag('event', 'quiz_completed', {
                 'result': 'correct',
                 'time_taken': timeTaken,
                 'event_category': 'engagement',
                 'event_label': 'Quiz Correct'
               });
             }
           } else {
             quizBanner.textContent = "Wrong Answer";
             message.innerHTML = `Oh oh.. Incorrect! 😔<br>Try again in 5 seconds!`;
             modalContent.classList.remove("correct-answer");
             shareBtn.style.display = "none";
             shareText.style.display = "none";
             popupButtonRow.innerHTML = ''; // Remove OK button for wrong answer
             progressBar.style.display = "block";
             progressFill.style.width = "0";
             setTimeout(() => progressFill.style.width = "100%", 10);
             setTimeout(() => {
               progressBar.style.display = "none";
               closePopup();
             }, 5000);
           }
           popup.style.display = "flex";
           document.body.classList.add('no-scroll');
         }
         function closePopup() {
           document.getElementById("popup").style.display = 'none';
           document.getElementById("progressBar").style.display = 'none';
           document.getElementById("progressFill").style.width = '0';
           document.querySelector(".modal-content").classList.remove("correct-answer");
           document.body.classList.remove('no-scroll');
         }
         async function toggleLikePhrase() {
  let phrase = phrases[currentIndex]?.phrase || '';
  let likedPhrases = JSON.parse(localStorage.getItem('likedPhrases') || '[]');
  const isLiked = likedPhrases.includes(phrase);
  const likeBtn = document.getElementById('likeBtn');
  
  if (isLiked) {
    // Unlike the phrase
    likedPhrases = likedPhrases.filter(p => p !== phrase);
    localStorage.setItem('likedPhrases', JSON.stringify(likedPhrases));
    likeBtn.innerHTML = '<i class="fa-regular fa-heart"></i>';
    try {
      let data = await fetchWithRetry(`${COMMENT_URL}?action=removeLike&phrase=${encodeURIComponent(phrase)}`, {
        method: 'POST'
      });
      if (!data || data.status !== 'success') {
        throw new Error(data?.message || 'Invalid response from server');
      }
      if (localStorage.getItem('cookieConsent') === 'accepted') {
        gtag('event', 'phrase_unliked', {
          'phrase': phrase,
          'event_category': 'engagement',
          'event_label': 'Phrase Unliked'
        });
      }
    } catch (e) {
      console.error('Error removing like:', e);
      likedPhrases.push(phrase);
      localStorage.setItem('likedPhrases', JSON.stringify(likedPhrases));
      likeBtn.innerHTML = '<i class="fa-solid fa-heart"></i>';
      alert('Failed to unlike phrase: ' + e.message);
    }
  } else {
    // Like the phrase with animation
    likeBtn.classList.add('liked-anim'); // Trigger animation
    setTimeout(() => likeBtn.classList.remove('liked-anim'), 300); // Remove class after animation
    likedPhrases.push(phrase);
    localStorage.setItem('likedPhrases', JSON.stringify(likedPhrases));
    likeBtn.innerHTML = '<i class="fa-solid fa-heart"></i>';
    try {
      let data = await fetchWithRetry(`${COMMENT_URL}?action=addLike&phrase=${encodeURIComponent(phrase)}`, {
        method: 'POST'
      });
      if (!data || data.status !== 'success' || typeof data.likes !== 'number') {
        throw new Error(data?.message || 'Invalid response from server');
      }
      if (localStorage.getItem('cookieConsent') === 'accepted') {
        gtag('event', 'phrase_liked', {
          'phrase': phrase,
          'event_category': 'engagement',
          'event_label': 'Phrase Liked'
        });
      }
    } catch (e) {
      console.error('Error adding like:', e);
      likedPhrases = likedPhrases.filter(p => p !== phrase);
      localStorage.setItem('likedPhrases', JSON.stringify(likedPhrases));
      likeBtn.innerHTML = '<i class="fa-regular fa-heart"></i>';
      alert('Failed to like phrase: ' + e.message);
    }
  }
}
         document.getElementById('likeBtn').onclick = toggleLikePhrase;
         function showCommentPopup() {
           document.getElementById('commentPopup').style.display = 'flex';
           document.body.classList.add('no-scroll');
           document.getElementById('username').value = '';
           document.getElementById('commentText').value = '';
         }
         document.getElementById('commentBtn').onclick = showCommentPopup;
         function closeCommentPopup() {
           document.getElementById('commentPopup').style.display = 'none';
           document.body.classList.remove('no-scroll');
         }
         
         function showReplyPopup(commentId) {
           currentCommentId = commentId;
           document.getElementById('replyPopup').style.display = 'flex';
           document.body.classList.add('no-scroll');
           document.getElementById('replyUsername').value = '';
           document.getElementById('replyText').value = '';
         }
         function closeReplyPopup() {
           document.getElementById('replyPopup').style.display = 'none';
           document.body.classList.remove('no-scroll');
           currentCommentId = null;
         }
         function submitComment() {
  let username = document.getElementById('username').value.trim();
  let comment = document.getElementById('commentText').value.trim();
  const submitCommentBtn = document.querySelector('#commentPopup button[onclick="submitComment()"]');
  if (!username || !comment) {
    alert('Please enter both a username and a comment.');
    return;
  }
  submitCommentBtn.disabled = true; // Disable button to prevent multiple clicks
  closeCommentPopup(); // Close popup immediately
  fetchWithRetry(`${COMMENT_URL}?action=addComment`, {
    method: 'POST',
    body: new URLSearchParams({
      timestamp: new Date().toISOString(),
      username: username,
      comment: comment
    })
  }).then(data => {
    if (!data || data.status !== 'success' || !data.id) {
      throw new Error(data?.message || 'Invalid response from server');
    }
    if (localStorage.getItem('cookieConsent') === 'accepted') {
      gtag('event', 'comment_added', {
        'event_category': 'engagement',
        'event_label': 'Comment Added'
      });
    }
    loadComments(currentCommentPage);
  }).catch(e => {
    console.error('Error adding comment:', e);
    alert('Failed to add comment: ' + e.message);
  }).finally(() => {
    submitCommentBtn.disabled = false; // Re-enable button
  });
}

function submitReply() {
  let username = document.getElementById('replyUsername').value.trim();
  let reply = document.getElementById('replyText').value.trim();
  const submitReplyBtn = document.querySelector('#replyPopup button[onclick="submitReply()"]');
  if (!username || !reply || !currentCommentId) {
    alert('Please enter both a username and a reply.');
    return;
  }
  submitReplyBtn.disabled = true; // Disable button to prevent multiple clicks
  closeReplyPopup(); // Close popup immediately
  fetchWithRetry(`${COMMENT_URL}?action=addReply`, {
    method: 'POST',
    body: new URLSearchParams({
      timestamp: new Date().toISOString(),
      username: username,
      comment: reply,
      parentId: currentCommentId
    })
  }).then(data => {
    if (!data || data.status !== 'success' || !data.id) {
      throw new Error(data?.message || 'Invalid response from server');
    }
    if (localStorage.getItem('cookieConsent') === 'accepted') {
      gtag('event', 'reply_added', {
        'event_category': 'engagement',
        'event_label': 'Reply Added'
      });
    }
    loadComments(currentCommentPage);
  }).catch(e => {
    console.error('Error adding reply:', e);
    alert('Failed to add reply: ' + e.message);
  }).finally(() => {
    submitReplyBtn.disabled = false; // Re-enable button
  });
}
         async function likeComment(commentId, isReply) {
           const userId = generateUserId();
           let likedComments = JSON.parse(localStorage.getItem('likedComments') || '[]');
           if (likedComments.includes(commentId)) {
             return; // Already liked
           }
           try {
             let data = await fetchWithRetry(`${COMMENT_URL}?action=addCommentLike&commentId=${encodeURIComponent(commentId)}&isReply=${isReply}&userId=${userId}`, {
               method: 'POST'
             });
             if (!data || data.status !== 'success' || typeof data.likes !== 'number') {
               throw new Error(data?.message || 'Invalid response from server');
             }
             likedComments.push(commentId);
             localStorage.setItem('likedComments', JSON.stringify(likedComments));
             let commentElement = document.querySelector(`[data-comment-id="${commentId}"]`);
             if (commentElement) {
               let likeButton = commentElement.querySelector('button[aria-label^="Like this"]');
               let likeCountElement = commentElement.querySelector('.like-count');
               if (likeButton && likeCountElement) {
                 likeButton.disabled = true;
                 likeButton.innerHTML = `<i class="fa-solid fa-heart"></i> Like (<span class="like-count">${data.likes}</span>)`;
               }
             }
             if (localStorage.getItem('cookieConsent') === 'accepted') {
               gtag('event', 'comment_liked', {
                 'is_reply': isReply,
                 'event_category': 'engagement',
                 'event_label': isReply ? 'Reply Liked' : 'Comment Liked'
               });
             }
           } catch (e) {
             console.error('Error liking comment:', e);
             alert('Failed to like comment: ' + e.message);
           }
         }
      function globalShare() {
  const isPhraseSection = document.getElementById('phraseSection').style.display === 'block';
  const currentPhrase = phrases[currentIndex]?.phrase || '';
  if (navigator.share) {
    const shareData = isPhraseSection ? {
      title: 'FlyTie - Phrase of the Day',
      text: `Did you know what does "${currentPhrase}" mean? Check out FlyTie app to learn more on such professional phrases daily!`,
      url: window.location.href
    } : {
      title: 'FlyTie - Phrase of the Day',
      text: 'Check out FlyTie to learn new professional phrases daily!',
      url: window.location.href
    };
    navigator.share(shareData).then(() => {
      if (localStorage.getItem('cookieConsent') === 'accepted') {
        gtag('event', 'global_share', {
          'event_category': 'engagement',
          'event_label': isPhraseSection ? 'Phrase Share' : 'Global Share'
        });
      }
      document.activeElement.blur(); // Remove focus to reset Share button state
    }).catch(err => {
      if (err.name === 'AbortError' || err.name === 'NotAllowedError' || err.message.toLowerCase().includes('cancel')) {
        document.activeElement.blur(); // Remove focus even if share is canceled
        return;
      }
      console.error('Error sharing:', err);
      alert('Error sharing: An unexpected error occurred. Please try again.');
      document.activeElement.blur(); // Remove focus on error
    });
  } else {
    alert("Sharing not supported on this browser.");
    document.activeElement.blur(); // Remove focus when alert is shown
  }
}
         function shareResult() {
           if (navigator.share) {
             let timeTaken = document.getElementById('shareBtn').dataset.time || '0';
             let timeUnit = parseFloat(timeTaken) >= 60 ? 'minutes' : 'seconds';
             if (timeUnit === 'minutes') {
               timeTaken = (parseFloat(timeTaken) / 60).toFixed(2);
             }
             navigator.share({
               title: 'FlyTie - Quiz Result',
               text: `On FlyTie, I got the quiz right in ${timeTaken} ${timeUnit}! Try it yourself!`,
               url: window.location.href
             }).then(() => {
               if (localStorage.getItem('cookieConsent') === 'accepted') {
                 gtag('event', 'quiz_result_shared', {
                   'event_category': 'engagement',
                   'event_label': 'Quiz Result Shared'
                 });
               }
             }).catch(err => {
               if (err.name === 'AbortError' || err.name === 'NotAllowedError' || err.message.toLowerCase().includes('cancel')) {
                 return;
               }
               console.error('Error sharing quiz result:', err);
               alert('Error sharing quiz result: An unexpected error occurred. Please try again.');
             });
           } else {
             alert("Sharing not supported on this browser.");
           }
         }
         window.onload = () => {
           updateStreak();
           loadPhrases();
           loadComments();
           showSection('phrase'); // Ensure phrase section is shown by default
         };
      </script>
   </body>
</html>